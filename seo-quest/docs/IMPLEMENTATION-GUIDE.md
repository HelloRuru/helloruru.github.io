# SEO Quest â€” å¯¦ä½œæŒ‡å—

> æ•´åˆæ‰€æœ‰å„ªåŒ–å»ºè­°çš„å®Œæ•´å¯¦ä½œè¦ç¯„
> æ›´æ–°æ—¥æœŸï¼š2026-02-12

---

## ğŸ“‹ ç›®éŒ„

- [å»ºè­°ç¸½è¦½](#å»ºè­°ç¸½è¦½)
- [é–‹ç™¼è€…é«”é©—å¼·åŒ–ï¼ˆæ–°å¢ï¼‰](#é–‹ç™¼è€…é«”é©—å¼·åŒ–æ–°å¢)
- [å„ªå…ˆç´šåˆ†é¡](#å„ªå…ˆç´šåˆ†é¡)
- [æŠ€è¡“å¯¦ä½œè¦ç¯„](#æŠ€è¡“å¯¦ä½œè¦ç¯„)
- [UI/UX å¢å¼·](#uiux-å¢å¼·)
- [ç€è¦½å™¨ç›¸å®¹æ€§](#ç€è¦½å™¨ç›¸å®¹æ€§)

---

## ğŸ“Š å»ºè­°ç¸½è¦½

### A. æ¶æ§‹å±¤ç´šå»ºè­°

| # | é¡åˆ¥ | å»ºè­°é …ç›® | ä¾†æº | å„ªå…ˆç´š |
|---|------|---------|------|--------|
| 1 | å®‰å…¨æ€§ | å…¬å¼å­—ä¸²åŒ–æ”¹ç‚º Calculator ID ç³»çµ± | Gemini (Variation B) | ğŸ”´ P0 å¿…é ˆ |
| 2 | å‹åˆ¥å®‰å…¨ | ä½¿ç”¨ Zod é€²è¡Œ JSON Schema é©—è­‰ | Gemini (Variation B) | ğŸ”´ P0 å¿…é ˆ |
| 3 | ç‹€æ…‹ç®¡ç† | åˆ†é›¢æŒä¹…åŒ–æ•¸æ“šèˆ‡è¨ˆç®—æ•¸æ“š | Gemini (Variation B) | ğŸ”´ P0 å¿…é ˆ |
| 4 | éšæ®µç³»çµ± | æ”¹ç”¨ Array çµæ§‹æ”¯æ´å½ˆæ€§é †åº | Gemini (Variation A) | ğŸŸ  P1 é‡è¦ |
| 5 | ç‹€æ…‹æ©Ÿ | ä½¿ç”¨ FSM ç®¡ç†éšæ®µæµè½‰ | Gemini (Variation B) | ğŸŸ  P1 é‡è¦ |

### B. åŠŸèƒ½å±¤ç´šå»ºè­°

| # | é¡åˆ¥ | å»ºè­°é …ç›® | ä¾†æº | å„ªå…ˆç´š |
|---|------|---------|------|--------|
| 6 | å°è©±ç³»çµ± | å¢åŠ  emotionã€delayã€action æ¬„ä½ | User Request | ğŸŸ  P1 é‡è¦ |
| 7 | è³‡ç”¢ç®¡ç† | çµ±ä¸€ Asset é…ç½®æª”ï¼ˆEmoji â‡„ åœ–ç‰‡ï¼‰ | User Request | ğŸŸ  P1 é‡è¦ |
| 8 | æˆå°±ç³»çµ± | Event Listener + ç…™ç«ç‰¹æ•ˆ | User Request | ğŸŸ¡ P2 å»ºè­° |
| 9 | è©•åˆ†å¼•æ“ | æ¨¡çµ„åŒ–ç‚ºç¨ç«‹çš„ç´”å‡½æ•¸ | Gemini (Variation B) | ğŸŸ  P1 é‡è¦ |
| 10 | è³‡æ–™åŒæ­¥ | StorageManager ç‰ˆæœ¬é·ç§»æ©Ÿåˆ¶ | Gemini (Variation B) | ğŸŸ  P1 é‡è¦ |

### C. UI/UX å±¤ç´šå»ºè­°

| # | é¡åˆ¥ | å»ºè­°é …ç›® | ä¾†æº | å„ªå…ˆç´š |
|---|------|---------|------|--------|
| 11 | è½‰å ´å‹•ç•« | éšæ®µé–“å…¨è¢å¹•è½‰å ´ï¼ˆæ²è»¸ã€åœ°åœ–ç§»å‹•ï¼‰ | Gemini (å¯¶å¯¶å‰ä¼Š) | ğŸŸ¡ P2 å»ºè­° |
| 12 | è©•åˆ†è¦–è¦ºåŒ– | å‹•æ…‹å„€è¡¨æ¿ã€æ•¸å­—è·³å‹•ã€æ…¶ç¥ç‰¹æ•ˆ | Gemini (å¯¶å¯¶å‰ä¼Š) | ğŸŸ¡ P2 å»ºè­° |
| 13 | äº’å‹•åœ°åœ– | å½©è‰²/ç°è‰²é—œå¡ã€æ‡¸åœé è¦½ | Gemini (å¯¶å¯¶å‰ä¼Š) | ğŸŸ¡ P2 å»ºè­° |
| 14 | æç¤ºç³»çµ± | å¡é—œæ™‚çš„æ¼¸é€²å¼æç¤º | Gemini (Variation A) | ğŸŸ¢ P3 å„ªåŒ– |
| 15 | æƒ…æ„Ÿå›é¥‹ | NPC åæ‡‰æ–‡å­—ï¼ˆreaction_textï¼‰ | Gemini (Variation A) | ğŸŸ¢ P3 å„ªåŒ– |

### D. æŠ€è¡“æ–‡ä»¶å»ºè­°

| # | é¡åˆ¥ | å»ºè­°é …ç›® | ä¾†æº | å„ªå…ˆç´š |
|---|------|---------|------|--------|
| 16 | ç›¸å®¹æ€§èªªæ˜ | ç€è¦½å™¨æœ€ä½ç‰ˆæœ¬éœ€æ±‚ | Gemini (æ¢å“¡å…”å…”) | ğŸŸ  P1 é‡è¦ |
| 17 | JSON è¼‰å…¥ | CORS èˆ‡è·¯å¾‘åƒç…§èªªæ˜ | Gemini (æ¢å“¡å…”å…”) | ğŸŸ  P1 é‡è¦ |
| 18 | CSS è®Šæ•¸ | é›™å±¤è®Šæ•¸æ¶æ§‹ï¼ˆPrimitive + Semanticï¼‰ | Gemini (Variation B) | ğŸŸ¡ P2 å»ºè­° |
| 19 | éŸ¿æ‡‰å¼ | æ•´åˆåˆ°å…ƒä»¶å…§è€Œéç¨ç«‹æª”æ¡ˆ | Gemini (Variation B) | ğŸŸ¢ P3 å„ªåŒ– |

---

## ğŸ”§ é–‹ç™¼è€…é«”é©—å¼·åŒ–ï¼ˆæ–°å¢ï¼‰

> **ä¾†æº**ï¼šGemini ç¬¬äºŒè¼ªæ¶æ§‹å»ºè­°ï¼ˆé€éåš•åš•ä¸»äººå‚³é”ï¼‰
> **æ›´æ–°æ—¥æœŸ**ï¼š2026-02-12

### E. å…¨åŸŸé…ç½®èˆ‡éŒ¯èª¤è™•ç†

| # | é¡åˆ¥ | å»ºè­°é …ç›® | å„ªå…ˆç´š |
|---|------|---------|--------|
| 20 | é…ç½®ç®¡ç† | GameConfig é›†ä¸­ç®¡ç†éœæ…‹è®Šæ•¸èˆ‡éŠæˆ²åƒæ•¸ | ğŸ”´ P0 å¿…é ˆ |
| 21 | éŒ¯èª¤è™•ç† | ErrorBoundary å…¨åŸŸéŒ¯èª¤æ””æˆª | ğŸ”´ P0 å¿…é ˆ |
| 22 | æ•ˆèƒ½å„ªåŒ– | ResourceLoader è³‡æºé è¼‰å…¥ | ğŸŸ  P1 é‡è¦ |

### F. ç¨‹å¼ç¢¼å“è³ªèˆ‡æ¶æ§‹

| # | é¡åˆ¥ | å»ºè­°é …ç›® | å„ªå…ˆç´š |
|---|------|---------|--------|
| 23 | äº‹ä»¶ç³»çµ± | EventBus åš´è¬¹çš„ Pub/Sub æ¶æ§‹ | ğŸ”´ P0 å¿…é ˆ |
| 24 | å‹åˆ¥æ–‡ä»¶ | JSDoc å®Œæ•´å‹åˆ¥è¨»é‡‹ | ğŸŸ  P1 é‡è¦ |
| 25 | æ•ˆèƒ½å„ªåŒ– | Dynamic Import å‹•æ…‹è¼‰å…¥æ¨¡çµ„ | ğŸŸ  P1 é‡è¦ |
| 26 | ç‹€æ…‹ç®¡ç† | Store Pattern (Redux-like) | ğŸ”´ P0 å¿…é ˆ |
| 27 | CSS æ¶æ§‹ | Palette + Semantic é›™å±¤è®Šæ•¸ | ğŸŸ  P1 é‡è¦ |

---

## ğŸ¯ å„ªå…ˆç´šåˆ†é¡

### ğŸ”´ P0 - å¿…é ˆå¯¦ä½œï¼ˆæ¶æ§‹åŸºç¤ï¼‰

#### 1. Calculator ID ç³»çµ±
```typescript
// âœ… å·²è¨­è¨ˆå®Œæˆ
enum ScoringAlgorithmId {
  KEYWORD_DENSITY = 'KEYWORD_DENSITY_CALC',
  FLESCH_READING_EASE = 'FLESCH_READING_EASE_CALC',
  // ...
}

class ScoringCalculator {
  calculate(algorithmId, content, params): AlgorithmResult
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/types/scoring-algorithms.ts`
- `js/modules/scoring-calculator.ts`
- åƒè€ƒï¼š`TECHNICAL-OPTIMIZATION.md`

---

#### 2. Zod Schema é©—è­‰
```typescript
// âœ… å·²è¨­è¨ˆå®Œæˆ
import { z } from 'zod';

const LevelDataSchema = z.object({
  id: z.string(),
  version: z.string(),
  phases: z.array(PhaseSchema),
  // ...
});
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/schemas/level-schema.ts`
- åƒè€ƒï¼š`TECHNICAL-OPTIMIZATION.md`

---

#### 3. ç‹€æ…‹æ­£è¦åŒ–
```typescript
// âœ… å·²è¨­è¨ˆå®Œæˆ
interface UserPersistedData {
  level: number;
  exp: number;
  // åªå­˜å¿…è¦æ•¸æ“š
}

interface UserComputedData {
  nextLevelExp: number;  // è¨ˆç®—è€Œä¾†
  expProgress: number;
  // ...
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/types/user-state.ts`
- `js/core/user-state-manager.ts`
- åƒè€ƒï¼š`TECHNICAL-OPTIMIZATION.md`

---

### ğŸŸ  P1 - é‡è¦åŠŸèƒ½ï¼ˆæ ¸å¿ƒé«”é©—ï¼‰

#### 4. æœ‰é™ç‹€æ…‹æ©Ÿï¼ˆFSMï¼‰

**éœ€æ±‚**ï¼šç®¡ç†éšæ®µæµè½‰ï¼Œé˜²æ­¢è·³é—œæˆ–é€†å‘æ“ä½œ

```typescript
// js/core/phase-state-machine.ts

enum PhaseState {
  TUTORIAL = 'tutorial',
  DEMO = 'demo',
  PRACTICE = 'practice',
  SCORE = 'score',
  LEVELUP = 'levelup'
}

enum PhaseEvent {
  NEXT = 'NEXT',
  PREVIOUS = 'PREVIOUS',
  JUMP = 'JUMP',
  RESET = 'RESET'
}

interface StateTransition {
  from: PhaseState;
  event: PhaseEvent;
  to: PhaseState;
  guard?: () => boolean;  // æ¢ä»¶æª¢æŸ¥
}

class PhaseStateMachine {
  private currentState: PhaseState;
  private transitions: StateTransition[];
  private stateHistory: PhaseState[] = [];

  constructor(initialState: PhaseState) {
    this.currentState = initialState;
    this.transitions = this.defineTransitions();
  }

  /**
   * å®šç¾©ç‹€æ…‹è½‰æ›è¦å‰‡
   */
  private defineTransitions(): StateTransition[] {
    return [
      // Tutorial â†’ Demoï¼ˆä¸‹ä¸€æ­¥ï¼‰
      {
        from: PhaseState.TUTORIAL,
        event: PhaseEvent.NEXT,
        to: PhaseState.DEMO
      },

      // Demo â†’ Practiceï¼ˆä¸‹ä¸€æ­¥ï¼‰
      {
        from: PhaseState.DEMO,
        event: PhaseEvent.NEXT,
        to: PhaseState.PRACTICE
      },

      // Practice â†’ Scoreï¼ˆä¸‹ä¸€æ­¥ï¼Œéœ€å®Œæˆä½œç­”ï¼‰
      {
        from: PhaseState.PRACTICE,
        event: PhaseEvent.NEXT,
        to: PhaseState.SCORE,
        guard: () => this.hasCompletedPractice()
      },

      // Score â†’ Levelupï¼ˆä¸‹ä¸€æ­¥ï¼‰
      {
        from: PhaseState.SCORE,
        event: PhaseEvent.NEXT,
        to: PhaseState.LEVELUP
      },

      // å…è¨±è¿”å›ä¸Šä¸€æ­¥ï¼ˆä½†ä¸èƒ½è·³é—œï¼‰
      {
        from: PhaseState.DEMO,
        event: PhaseEvent.PREVIOUS,
        to: PhaseState.TUTORIAL
      },

      {
        from: PhaseState.PRACTICE,
        event: PhaseEvent.PREVIOUS,
        to: PhaseState.DEMO
      }

      // æ³¨æ„ï¼šä¸å…è¨±å¾ Score è¿”å› Practiceï¼ˆé˜²æ­¢é‡è¤‡åˆ·åˆ†ï¼‰
      // æ³¨æ„ï¼šä¸å…è¨±è·³é—œï¼ˆé˜²æ­¢ç ´å£å­¸ç¿’æµç¨‹ï¼‰
    ];
  }

  /**
   * å˜—è©¦è½‰æ›ç‹€æ…‹
   */
  transition(event: PhaseEvent): boolean {
    const transition = this.transitions.find(t =>
      t.from === this.currentState && t.event === event
    );

    if (!transition) {
      console.warn(`Invalid transition: ${this.currentState} + ${event}`);
      return false;
    }

    // æª¢æŸ¥ guard æ¢ä»¶
    if (transition.guard && !transition.guard()) {
      console.warn(`Guard failed for: ${this.currentState} â†’ ${transition.to}`);
      return false;
    }

    // è¨˜éŒ„æ­·å²
    this.stateHistory.push(this.currentState);

    // åŸ·è¡Œè½‰æ›
    this.currentState = transition.to;

    // è§¸ç™¼äº‹ä»¶
    this.onStateChange(transition.to);

    return true;
  }

  /**
   * ç‹€æ…‹è®Šæ›´å›èª¿
   */
  private onStateChange(newState: PhaseState): void {
    console.log(`Phase transition: â†’ ${newState}`);
    EventBus.emit('phase:changed', newState);
  }

  /**
   * ç²å–ç•¶å‰ç‹€æ…‹
   */
  getState(): PhaseState {
    return this.currentState;
  }

  /**
   * æª¢æŸ¥æ˜¯å¦å¯ä»¥åŸ·è¡ŒæŸå€‹äº‹ä»¶
   */
  canTransition(event: PhaseEvent): boolean {
    const transition = this.transitions.find(t =>
      t.from === this.currentState && t.event === event
    );

    if (!transition) return false;
    if (transition.guard) return transition.guard();

    return true;
  }

  /**
   * é‡ç½®ç‹€æ…‹
   */
  reset(initialState: PhaseState = PhaseState.TUTORIAL): void {
    this.currentState = initialState;
    this.stateHistory = [];
  }

  // Guard å‡½æ•¸
  private hasCompletedPractice(): boolean {
    // æª¢æŸ¥æ˜¯å¦å·²æäº¤ä½œå“
    return State.current.practiceCompleted === true;
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const fsm = new PhaseStateMachine(PhaseState.TUTORIAL);

// å˜—è©¦ä¸‹ä¸€æ­¥
if (fsm.canTransition(PhaseEvent.NEXT)) {
  fsm.transition(PhaseEvent.NEXT);
} else {
  Toast.show('è«‹å…ˆå®Œæˆç•¶å‰éšæ®µ', 'warning');
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/phase-state-machine.ts`
- `js/types/phase-states.ts`

**æ•´åˆåˆ°**ï¼š
- `js/core/router.js` - ä½¿ç”¨ FSM ç®¡ç†éšæ®µåˆ‡æ›

---

#### 5. è©•åˆ†å¼•æ“æ¨¡çµ„åŒ–

```typescript
// js/services/scoring-service.ts

/**
 * ç´”å‡½æ•¸ï¼šé—œéµå­—å¯†åº¦è¨ˆç®—
 */
export function calculateKeywordDensity(
  content: string,
  keyword: string
): number {
  const totalWords = content.split(/\s+/).length;
  const regex = new RegExp(keyword, 'gi');
  const keywordCount = (content.match(regex) || []).length;

  return (keywordCount / totalWords) * 100;
}

/**
 * ç´”å‡½æ•¸ï¼šå¯è®€æ€§è¨ˆç®—ï¼ˆFleschï¼‰
 */
export function calculateFleschReadingEase(content: string): number {
  const sentences = content.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.trim()).length;
  const words = content.split(/\s+/).length;
  const syllables = content.replace(/\s+/g, '').length;

  const score = 206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / words);
  return Math.max(0, Math.min(100, score));
}

/**
 * ç´”å‡½æ•¸ï¼šå¹³å‡å¥é•·è¨ˆç®—
 */
export function calculateAverageSentenceLength(content: string): number {
  const sentences = content.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.trim());
  const totalWords = content.split(/\s+/).length;

  return totalWords / sentences.length;
}

/**
 * è©•åˆ†æœå‹™é¡åˆ¥
 */
export class ScoringService {
  /**
   * åŸ·è¡Œå®Œæ•´è©•åˆ†
   */
  score(content: string, criteria: ScoringCriteria): ScoringResult {
    const scores: Record<string, number> = {};

    // é—œéµå­—å„ªåŒ–
    if (criteria.keywordOptimization) {
      scores.keywordOptimization = this.scoreKeywordOptimization(
        content,
        criteria.keywordOptimization
      );
    }

    // å¯è®€æ€§
    if (criteria.readability) {
      scores.readability = this.scoreReadability(content);
    }

    // çµæ§‹æ¸…æ™°åº¦
    if (criteria.structure) {
      scores.structure = this.scoreStructure(content);
    }

    // åŠ æ¬Šè¨ˆç®—ç¸½åˆ†
    const totalScore = this.calculateWeightedScore(scores, criteria.weights);

    return {
      totalScore,
      breakdown: scores,
      grade: this.getGrade(totalScore),
      suggestions: this.generateSuggestions(scores, content)
    };
  }

  /**
   * é—œéµå­—å„ªåŒ–è©•åˆ†
   */
  private scoreKeywordOptimization(
    content: string,
    config: KeywordConfig
  ): number {
    const density = calculateKeywordDensity(content, config.primaryKeyword);

    // ç†æƒ³å¯†åº¦ï¼š1.5-2.5%
    if (density >= 1.5 && density <= 2.5) {
      return 100;
    } else if (density < 1.5) {
      return Math.max(0, 100 - (1.5 - density) * 30);
    } else {
      return Math.max(0, 100 - (density - 2.5) * 40);
    }
  }

  /**
   * å¯è®€æ€§è©•åˆ†
   */
  private scoreReadability(content: string): number {
    const fleschScore = calculateFleschReadingEase(content);
    const avgLength = calculateAverageSentenceLength(content);

    // å¯è®€æ€§åˆ†æ•¸
    let score = fleschScore * 0.6;

    // å¥é•·æ‡²ç½°/çå‹µ
    if (avgLength >= 12 && avgLength <= 20) {
      score += 40;  // ç†æƒ³å¥é•·
    } else if (avgLength < 12) {
      score += 40 - (12 - avgLength) * 5;
    } else {
      score += 40 - (avgLength - 20) * 3;
    }

    return Math.max(0, Math.min(100, score));
  }

  /**
   * çµæ§‹è©•åˆ†
   */
  private scoreStructure(content: string): number {
    let score = 0;

    // æ˜¯å¦æœ‰æ¨™é¡Œ
    if (content.match(/^ã€.+ã€‘/)) {
      score += 30;
    }

    // æ®µè½åˆ†æ˜ï¼ˆæª¢æŸ¥æ›è¡Œï¼‰
    const paragraphs = content.split('\n\n').filter(p => p.trim());
    if (paragraphs.length >= 2) {
      score += 40;
    }

    // ä½¿ç”¨åˆ—é»æˆ–æ•¸å­—
    if (content.match(/^[0-9]\.|\n[0-9]\./m) || content.match(/^[-â€¢]\s/m)) {
      score += 30;
    }

    return score;
  }

  /**
   * åŠ æ¬Šè¨ˆç®—
   */
  private calculateWeightedScore(
    scores: Record<string, number>,
    weights: Record<string, number>
  ): number {
    let totalScore = 0;
    let totalWeight = 0;

    Object.keys(scores).forEach(key => {
      const weight = weights[key] || 0;
      totalScore += scores[key] * (weight / 100);
      totalWeight += weight;
    });

    return Math.round(totalScore / (totalWeight / 100));
  }

  /**
   * è©•ç´š
   */
  private getGrade(score: number): string {
    if (score >= 95) return 'excellent';
    if (score >= 85) return 'good';
    if (score >= 75) return 'pass';
    if (score >= 65) return 'need_improve';
    return 'fail';
  }

  /**
   * ç”Ÿæˆå»ºè­°
   */
  private generateSuggestions(
    scores: Record<string, number>,
    content: string
  ): string[] {
    const suggestions: string[] = [];

    if (scores.keywordOptimization < 80) {
      const density = calculateKeywordDensity(content, 'ä¸»é—œéµå­—');
      if (density < 1.5) {
        suggestions.push('é—œéµå­—å¯†åº¦åä½ï¼Œå»ºè­°å¢åŠ  1-2 æ¬¡ä¸»é—œéµå­—');
      } else {
        suggestions.push('é—œéµå­—å¯†åº¦éé«˜ï¼Œå»ºè­°é™ä½ä½¿ç”¨æ¬¡æ•¸');
      }
    }

    if (scores.readability < 70) {
      suggestions.push('å¥å­åé•·ï¼Œå»ºè­°æ‹†åˆ†ç‚ºè¼ƒçŸ­çš„å¥å­');
    }

    if (scores.structure < 60) {
      suggestions.push('å»ºè­°ä½¿ç”¨æ¨™é¡Œã€åˆ—é»æˆ–æ•¸å­—ä¾†çµ„ç¹”å…§å®¹');
    }

    return suggestions;
  }
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/services/scoring-service.ts`
- `js/utils/text-analysis.ts`ï¼ˆç´”å‡½æ•¸ï¼‰

---

#### 6. StorageManager ç‰ˆæœ¬é·ç§»

```typescript
// js/core/storage-manager.ts

interface StorageSchema {
  version: string;
  data: any;
}

interface Migration {
  from: string;
  to: string;
  migrate: (oldData: any) => any;
}

class StorageManager {
  private readonly STORAGE_KEY = 'seo_quest_user';
  private readonly CURRENT_VERSION = '1.2';
  private migrations: Migration[] = [];

  constructor() {
    this.registerMigrations();
  }

  /**
   * è¨»å†Šæ‰€æœ‰é·ç§»è¦å‰‡
   */
  private registerMigrations(): void {
    // v1.0 â†’ v1.1ï¼šæ–°å¢ settings æ¬„ä½
    this.addMigration('1.0', '1.1', (oldData) => {
      return {
        ...oldData,
        settings: {
          mode: 'tutorial',
          soundEnabled: true,
          animationEnabled: true,
          hintsEnabled: true
        }
      };
    });

    // v1.1 â†’ v1.2ï¼šcompletedLevels çµæ§‹æ”¹è®Š
    this.addMigration('1.1', '1.2', (oldData) => {
      return {
        ...oldData,
        completedLevels: oldData.completedLevels.map((level: any) => ({
          id: level.levelId || level.id,
          completedAt: level.completedAt,
          score: level.score,
          grade: this.getGradeFromScore(level.score),
          attempts: level.attempts || 1,
          expGained: level.exp || 0
        }))
      };
    });
  }

  /**
   * æ–°å¢é·ç§»è¦å‰‡
   */
  private addMigration(from: string, to: string, migrateFn: (data: any) => any): void {
    this.migrations.push({ from, to, migrate: migrateFn });
  }

  /**
   * è¼‰å…¥è³‡æ–™ï¼ˆè‡ªå‹•é·ç§»ï¼‰
   */
  load(): UserPersistedData {
    const rawData = localStorage.getItem(this.STORAGE_KEY);

    if (!rawData) {
      return this.createDefaultData();
    }

    try {
      const schema: StorageSchema = JSON.parse(rawData);

      // æª¢æŸ¥ç‰ˆæœ¬
      if (schema.version === this.CURRENT_VERSION) {
        return schema.data;
      }

      // éœ€è¦é·ç§»
      console.log(`Migrating data from ${schema.version} to ${this.CURRENT_VERSION}`);
      const migratedData = this.migrate(schema.data, schema.version);

      // å„²å­˜é·ç§»å¾Œçš„è³‡æ–™
      this.save(migratedData);

      return migratedData;
    } catch (error) {
      console.error('Failed to load data:', error);
      return this.createDefaultData();
    }
  }

  /**
   * å„²å­˜è³‡æ–™
   */
  save(data: UserPersistedData): void {
    const schema: StorageSchema = {
      version: this.CURRENT_VERSION,
      data
    };

    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(schema));
  }

  /**
   * åŸ·è¡Œé·ç§»
   */
  private migrate(data: any, fromVersion: string): UserPersistedData {
    let currentData = data;
    let currentVersion = fromVersion;

    // æ‰¾å‡ºéœ€è¦åŸ·è¡Œçš„é·ç§»è·¯å¾‘
    const path = this.findMigrationPath(fromVersion, this.CURRENT_VERSION);

    if (!path) {
      throw new Error(`No migration path from ${fromVersion} to ${this.CURRENT_VERSION}`);
    }

    // ä¾åºåŸ·è¡Œé·ç§»
    path.forEach(migration => {
      console.log(`  Applying migration ${migration.from} â†’ ${migration.to}`);
      currentData = migration.migrate(currentData);
      currentVersion = migration.to;
    });

    return currentData;
  }

  /**
   * æ‰¾å‡ºé·ç§»è·¯å¾‘
   */
  private findMigrationPath(from: string, to: string): Migration[] | null {
    const path: Migration[] = [];
    let current = from;

    while (current !== to) {
      const migration = this.migrations.find(m => m.from === current);

      if (!migration) {
        return null;  // æ‰¾ä¸åˆ°è·¯å¾‘
      }

      path.push(migration);
      current = migration.to;

      // é˜²æ­¢ç„¡é™è¿´åœˆ
      if (path.length > 10) {
        console.error('Migration path too long');
        return null;
      }
    }

    return path;
  }

  /**
   * å»ºç«‹é è¨­è³‡æ–™
   */
  private createDefaultData(): UserPersistedData {
    return {
      level: 1,
      exp: 0,
      title: 'SEO æ–°æ‰‹',
      currentWorld: 1,
      currentLevel: '1-1',
      currentPhase: 'tutorial',
      completedLevels: [],
      unlockedAchievements: [],
      unlockedTools: [],
      unlockedNotes: [],
      totalAttempts: 0,
      totalCompleted: 0,
      scoreHistory: [],
      settings: {
        mode: 'tutorial',
        soundEnabled: true,
        animationEnabled: true,
        hintsEnabled: true,
        difficulty: 'normal'
      },
      createdAt: new Date().toISOString(),
      lastPlayedAt: new Date().toISOString()
    };
  }

  /**
   * æ¸…é™¤è³‡æ–™
   */
  clear(): void {
    localStorage.removeItem(this.STORAGE_KEY);
  }

  /**
   * åŒ¯å‡ºè³‡æ–™ï¼ˆå‚™ä»½ï¼‰
   */
  export(): string {
    const data = this.load();
    return JSON.stringify(data, null, 2);
  }

  /**
   * åŒ¯å…¥è³‡æ–™ï¼ˆé‚„åŸï¼‰
   */
  import(jsonString: string): boolean {
    try {
      const data = JSON.parse(jsonString);
      this.save(data);
      return true;
    } catch (error) {
      console.error('Failed to import data:', error);
      return false;
    }
  }

  private getGradeFromScore(score: number): string {
    if (score >= 95) return 'excellent';
    if (score >= 85) return 'good';
    if (score >= 75) return 'pass';
    return 'need_improve';
  }
}

// å…¨åŸŸå–®ä¾‹
export const Storage = new StorageManager();
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/storage-manager.ts`

---

## ğŸŒ ç€è¦½å™¨ç›¸å®¹æ€§

### æœ€ä½éœ€æ±‚

```markdown
**ç€è¦½å™¨ç›¸å®¹æ€§éœ€æ±‚**ï¼š

æœ¬å°ˆæ¡ˆä½¿ç”¨ ES6+ èˆ‡ ES Modulesï¼Œéœ€è¦æ”¯æ´ä»¥ä¸‹ç‰¹æ€§çš„ç¾ä»£ç€è¦½å™¨ï¼š

- âœ… Chrome 90+ (2021)
- âœ… Edge 90+ (2021)
- âœ… Safari 14+ (2020)
- âœ… Firefox 90+ (2021)

**ä¸æ”¯æ´**ï¼š
- âŒ Internet Explorer (ä»»ä½•ç‰ˆæœ¬)
- âŒ Chrome < 90
- âŒ Safari < 14

**æª¢æ¸¬æ–¹å¼**ï¼š

```javascript
// js/utils/browser-check.js

function checkBrowserCompatibility(): boolean {
  // æª¢æŸ¥ ES Modules æ”¯æ´
  if (!('noModule' in document.createElement('script'))) {
    return false;
  }

  // æª¢æŸ¥å…¶ä»–å¿…è¦ç‰¹æ€§
  const requiredFeatures = [
    'Promise',
    'fetch',
    'Map',
    'Set',
    'Array.prototype.find',
    'Object.assign'
  ];

  return requiredFeatures.every(feature => {
    return typeof eval(feature) !== 'undefined';
  });
}

// åœ¨è¼‰å…¥æ™‚æª¢æŸ¥
if (!checkBrowserCompatibility()) {
  document.body.innerHTML = `
    <div style="padding: 40px; text-align: center;">
      <h1>âš ï¸ ç€è¦½å™¨ç‰ˆæœ¬éèˆŠ</h1>
      <p>æœ¬ç¶²ç«™éœ€è¦ç¾ä»£ç€è¦½å™¨æ‰èƒ½æ­£å¸¸é‹ä½œã€‚</p>
      <p>è«‹æ›´æ–°è‡³ä»¥ä¸‹ç‰ˆæœ¬ï¼š</p>
      <ul style="list-style: none;">
        <li>Chrome 90+</li>
        <li>Edge 90+</li>
        <li>Safari 14+</li>
        <li>Firefox 90+</li>
      </ul>
    </div>
  `;
}
```

---

## ğŸ“¦ JSON è¼‰å…¥è™•ç†

### CORS èˆ‡è·¯å¾‘è™•ç†

```typescript
// js/core/json-loader.ts

class JSONLoader {
  private baseURL: string;

  constructor() {
    // è‡ªå‹•åµæ¸¬ç’°å¢ƒ
    this.baseURL = this.detectBaseURL();
  }

  /**
   * åµæ¸¬åŸºç¤ URL
   */
  private detectBaseURL(): string {
    // æª¢æŸ¥æ˜¯å¦ç‚º file:// å”å®š
    if (window.location.protocol === 'file:') {
      console.warn('Running on file:// protocol. Some features may not work.');
      // ä½¿ç”¨ç›¸å°è·¯å¾‘
      return '.';
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°ä¼ºæœå™¨
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return window.location.origin;
    }

    // ç”Ÿç”¢ç’°å¢ƒ
    return 'https://lab.helloruru.com/seo-quest';
  }

  /**
   * è¼‰å…¥ JSON
   */
  async load<T>(path: string): Promise<T> {
    const url = `${this.baseURL}/${path}`;

    try {
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      return data;
    } catch (error) {
      console.error(`Failed to load JSON from ${url}:`, error);

      // æä¾›å‹å–„çš„éŒ¯èª¤è¨Šæ¯
      if (window.location.protocol === 'file:') {
        throw new Error(
          'JSON è¼‰å…¥å¤±æ•—ï¼šè«‹ä½¿ç”¨ HTTP Server é–‹å•Ÿæœ¬å°ˆæ¡ˆï¼Œä¸æ”¯æ´ file:// å”å®šã€‚' +
          '\nå»ºè­°ï¼šåŸ·è¡Œ "python -m http.server 8000" æˆ– "npx serve"'
        );
      }

      throw error;
    }
  }

  /**
   * æ‰¹æ¬¡è¼‰å…¥
   */
  async loadBatch<T>(paths: string[]): Promise<T[]> {
    const promises = paths.map(path => this.load<T>(path));
    return Promise.all(promises);
  }

  /**
   * è¼‰å…¥é—œå¡
   */
  async loadLevel(levelId: string): Promise<LevelData> {
    const [world, level] = levelId.split('-');
    const path = `data/levels/world-${world}/${levelId}.json`;

    return this.load<LevelData>(path);
  }

  /**
   * è¼‰å…¥é…ç½®
   */
  async loadConfig(configName: string): Promise<any> {
    return this.load(`data/${configName}.json`);
  }
}

// å…¨åŸŸå–®ä¾‹
export const JSONLoader = new JSONLoader();
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// è¼‰å…¥é—œå¡
const levelData = await JSONLoader.loadLevel('1-1');

// è¼‰å…¥é…ç½®
const assetsConfig = await JSONLoader.loadConfig('assets-config');
const achievementsData = await JSONLoader.loadConfig('achievements');
```

---

## ğŸš€ é–‹ç™¼è€…é«”é©—å¼·åŒ–å¯¦ä½œ

> ä»¥ä¸‹ç‚º Gemini ç¬¬äºŒè¼ªå»ºè­°çš„å®Œæ•´å¯¦ä½œè¦ç¯„

---

### ğŸ® å»ºè­° #20ï¼šGameConfig é›†ä¸­ç®¡ç†

**ç›®çš„**ï¼šå°‡æ‰€æœ‰éœæ…‹è®Šæ•¸èˆ‡éŠæˆ²åƒæ•¸é›†ä¸­ç®¡ç†ï¼Œé¿å…æ•£è½åœ¨å„è™•

```typescript
// js/config/game-config.js

/**
 * SEO Quest éŠæˆ²é…ç½®
 *
 * æ­¤æª”æ¡ˆåŒ…å«ï¼š
 * 1. éœæ…‹å¸¸æ•¸ï¼ˆä¸æœƒæ”¹è®Šï¼‰
 * 2. éŠæˆ²åƒæ•¸ï¼ˆå¯èª¿æ•´ä½†ä¸éœ€ä¿®æ”¹é‚è¼¯ï¼‰
 */

export const GameConfig = {
  // ==================== å°ˆæ¡ˆè³‡è¨Š ====================
  meta: {
    name: 'SEO Quest',
    version: '1.0.0',
    author: 'Kaoru Tsai (Hello Ruru)',
    deployURL: 'https://lab.helloruru.com/seo-quest/',
    repository: 'https://github.com/helloruru/seo-quest'
  },

  // ==================== å„²å­˜é…ç½® ====================
  storage: {
    key: 'seo_quest_user',
    version: '1.2',
    autoSaveInterval: 30000  // 30 ç§’è‡ªå‹•å„²å­˜
  },

  // ==================== ç­‰ç´šç³»çµ± ====================
  level: {
    maxLevel: 10,
    expFormula: (level: number) => Math.floor(500 * Math.pow(1.5, level - 1)),
    titles: {
      1: 'SEO æ–°æ‰‹',
      2: 'SEO è¦‹ç¿’ç”Ÿ',
      3: 'SEO å¯¦ç¿’ç”Ÿ',
      5: 'SEO å°ˆå“¡',
      8: 'SEO å°ˆå®¶',
      10: 'SEO å¤§å¸«'
    }
  },

  // ==================== è©•åˆ†ç³»çµ± ====================
  scoring: {
    weights: {
      keywordOptimization: 30,  // é—œéµå­—å„ªåŒ–
      keywordUsage: 30,          // é—œéµå­—ä½¿ç”¨
      contentQuality: 40         // å…§å®¹å“è³ª
    },
    grades: {
      excellent: { min: 95, stars: 5, color: '#FFD700' },
      good: { min: 85, stars: 4, color: '#4CAF50' },
      pass: { min: 75, stars: 3, color: '#2196F3' },
      needImprove: { min: 65, stars: 2, color: '#FF9800' },
      fail: { min: 0, stars: 1, color: '#F44336' }
    },
    idealKeywordDensity: { min: 1.5, max: 2.5 },  // %
    idealSentenceLength: { min: 12, max: 20 }     // å­—æ•¸
  },

  // ==================== UI/UX åƒæ•¸ ====================
  ui: {
    // æ‰“å­—æ©Ÿæ•ˆæœé€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ï¼‰
    typewriterSpeed: {
      slow: 100,
      normal: 50,
      fast: 20,
      instant: 0
    },

    // å‹•ç•«æŒçºŒæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
    animation: {
      phaseTransition: 1000,    // éšæ®µè½‰å ´
      levelUpCelebration: 2000, // å‡ç´šæ…¶ç¥
      scoreCountUp: 1500,       // åˆ†æ•¸æ•¸å­—è·³å‹•
      toastDuration: 3000,      // Toast é¡¯ç¤ºæ™‚é–“
      dialoguePause: 800        // å°è©±é–“éš”
    },

    // è½‰å ´æ•ˆæœé–‹é—œ
    transitions: {
      scrollUnroll: true,       // Tutorial â†’ Demo
      mapMovement: true,        // Demo â†’ Practice
      cardFlip: true,           // Practice â†’ Score
      spotlight: true,          // Score â†’ Levelup
      particles: true           // ç…™ç«ç‰¹æ•ˆ
    },

    // éŸ³æ•ˆé–‹é—œï¼ˆæœªä¾†æ“´å……ï¼‰
    sound: {
      enabled: true,
      volume: 0.7,
      effects: {
        click: true,
        typewriter: true,
        achievement: true,
        levelup: true
      }
    },

    // æç¤ºç³»çµ±
    hints: {
      enabled: true,
      showAfterAttempts: 2,     // å¤±æ•— 2 æ¬¡å¾Œé¡¯ç¤ºæç¤º
      progressiveReveal: true   // æ¼¸é€²å¼æ­éœ²
    }
  },

  // ==================== è³‡æºé è¼‰å…¥ ====================
  preload: {
    critical: [
      'data/levels/world-1/1-1.json',
      'data/assets-config.json',
      'data/characters.json'
    ],
    images: {
      enabled: false,  // é è¨­ä½¿ç”¨ Emoji
      lazyLoad: true
    },
    showProgressBar: true
  },

  // ==================== æ•ˆèƒ½åƒæ•¸ ====================
  performance: {
    debounceDelay: 300,         // æœå°‹é˜²æŠ–ï¼ˆæ¯«ç§’ï¼‰
    throttleDelay: 100,         // æ»¾å‹•ç¯€æµï¼ˆæ¯«ç§’ï¼‰
    maxHistoryLength: 50,       // æœ€å¤§æ­·å²è¨˜éŒ„
    cacheExpiration: 3600000    // å¿«å–éæœŸæ™‚é–“ï¼ˆ1 å°æ™‚ï¼‰
  },

  // ==================== é–‹ç™¼æ¨¡å¼ ====================
  dev: {
    debug: false,               // é–‹å•Ÿ console.log
    skipTransitions: false,     // è·³éå‹•ç•«ï¼ˆæ¸¬è©¦ç”¨ï¼‰
    unlockAllLevels: false,     // è§£é–æ‰€æœ‰é—œå¡
    mockScoring: false,         // æ¨¡æ“¬è©•åˆ†ï¼ˆå›ºå®š 85 åˆ†ï¼‰
    showStateInUI: false        // åœ¨ UI é¡¯ç¤ºç‹€æ…‹ï¼ˆdebugï¼‰
  },

  // ==================== API ç«¯é»ï¼ˆæœªä¾†æ“´å……ï¼‰====================
  api: {
    baseURL: '',                // ç›®å‰ç´”å‰ç«¯ï¼Œç„¡ API
    timeout: 5000,              // è«‹æ±‚è¶…æ™‚
    retryAttempts: 3            // é‡è©¦æ¬¡æ•¸
  }
};

// ==================== è¼”åŠ©å‡½æ•¸ ====================

/**
 * ç²å–ä¸‹ä¸€ç­‰ç´šæ‰€éœ€ç¶“é©—å€¼
 */
export function getNextLevelExp(currentLevel: number): number {
  return GameConfig.level.expFormula(currentLevel + 1);
}

/**
 * ç²å–ç•¶å‰ç­‰ç´šç¨±è™Ÿ
 */
export function getLevelTitle(level: number): string {
  const titles = GameConfig.level.titles;

  // æ‰¾åˆ°æœ€æ¥è¿‘çš„ç¨±è™Ÿ
  const availableLevels = Object.keys(titles)
    .map(Number)
    .sort((a, b) => a - b);

  for (let i = availableLevels.length - 1; i >= 0; i--) {
    if (level >= availableLevels[i]) {
      return titles[availableLevels[i]];
    }
  }

  return titles[1];  // é è¨­æ–°æ‰‹
}

/**
 * ç²å–è©•ç´šè³‡è¨Š
 */
export function getGradeInfo(score: number): GradeInfo {
  const grades = GameConfig.scoring.grades;

  if (score >= grades.excellent.min) return { ...grades.excellent, name: 'excellent' };
  if (score >= grades.good.min) return { ...grades.good, name: 'good' };
  if (score >= grades.pass.min) return { ...grades.pass, name: 'pass' };
  if (score >= grades.needImprove.min) return { ...grades.needImprove, name: 'needImprove' };
  return { ...grades.fail, name: 'fail' };
}

/**
 * æª¢æŸ¥é—œéµå­—å¯†åº¦æ˜¯å¦ç†æƒ³
 */
export function isIdealKeywordDensity(density: number): boolean {
  const { min, max } = GameConfig.scoring.idealKeywordDensity;
  return density >= min && density <= max;
}

// ==================== å‹åˆ¥å®šç¾© ====================

interface GradeInfo {
  name: string;
  min: number;
  stars: number;
  color: string;
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```typescript
// å…¶ä»–æ¨¡çµ„ä¸­ä½¿ç”¨
import { GameConfig, getNextLevelExp, getLevelTitle } from './config/game-config.js';

// ç²å–æ‰“å­—æ©Ÿé€Ÿåº¦
const speed = GameConfig.ui.typewriterSpeed.normal;

// ç²å–ä¸‹ä¸€ç­‰ç´šç¶“é©—å€¼
const nextExp = getNextLevelExp(player.level);

// ç²å–ç¨±è™Ÿ
const title = getLevelTitle(player.level);

// æª¢æŸ¥æ˜¯å¦é–‹å•Ÿ debug æ¨¡å¼
if (GameConfig.dev.debug) {
  console.log('Current state:', state);
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/config/game-config.js`

---

### ğŸ›¡ï¸ å»ºè­° #21ï¼šErrorBoundary å…¨åŸŸéŒ¯èª¤æ””æˆª

**ç›®çš„**ï¼šå„ªé›…è™•ç†éŒ¯èª¤ï¼Œé¿å…ç™½å±ï¼Œæä¾›å¯æ„›çš„éŒ¯èª¤æç¤º

```typescript
// js/core/error-boundary.ts

interface ErrorContext {
  type: 'json-load' | 'storage-quota' | 'network' | 'validation' | 'unknown';
  message: string;
  originalError: Error;
  timestamp: number;
  userState?: any;
}

class ErrorBoundary {
  private errorLog: ErrorContext[] = [];
  private maxLogSize = 20;
  private errorHandlers: Map<string, (error: ErrorContext) => void> = new Map();

  constructor() {
    this.registerGlobalHandlers();
    this.registerSpecificHandlers();
  }

  /**
   * è¨»å†Šå…¨åŸŸéŒ¯èª¤è™•ç†
   */
  private registerGlobalHandlers(): void {
    // æ•ç²æœªè™•ç†çš„ Promise rejection
    window.addEventListener('unhandledrejection', (event) => {
      event.preventDefault();
      this.handleError({
        type: 'unknown',
        message: event.reason?.message || 'æœªçŸ¥éŒ¯èª¤',
        originalError: event.reason,
        timestamp: Date.now()
      });
    });

    // æ•ç²å…¨åŸŸéŒ¯èª¤
    window.addEventListener('error', (event) => {
      event.preventDefault();
      this.handleError({
        type: 'unknown',
        message: event.message,
        originalError: event.error,
        timestamp: Date.now()
      });
    });
  }

  /**
   * è¨»å†Šç‰¹å®šéŒ¯èª¤è™•ç†å™¨
   */
  private registerSpecificHandlers(): void {
    // JSON è¼‰å…¥å¤±æ•—
    this.registerHandler('json-load', (error) => {
      this.showFriendlyError({
        emoji: 'ğŸ“œâŒ',
        title: 'æ‰¾ä¸åˆ°åœ°åœ–å·è»¸...',
        message: 'é—œå¡è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ–æª”æ¡ˆä¸å­˜åœ¨ã€‚',
        suggestions: [
          'æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸',
          'é‡æ–°æ•´ç†é é¢è©¦è©¦',
          'å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯ç¹«åš•åš•ä¸»äºº'
        ],
        debugInfo: error.message
      });
    });

    // localStorage å®¹é‡ä¸è¶³
    this.registerHandler('storage-quota', (error) => {
      this.showFriendlyError({
        emoji: 'ğŸ’¾âŒ',
        title: 'å¯¶ç®±è£ä¸ä¸‹äº†...',
        message: 'å„²å­˜ç©ºé–“ä¸è¶³ï¼Œç„¡æ³•ä¿å­˜é€²åº¦ã€‚',
        suggestions: [
          'æ¸…é™¤ç€è¦½å™¨æš«å­˜è³‡æ–™',
          'åŒ¯å‡ºé€²åº¦å‚™ä»½å¾Œæ¸…é™¤èˆŠè³‡æ–™',
          'ä½¿ç”¨å…¶ä»–ç€è¦½å™¨'
        ],
        debugInfo: error.message,
        actions: [
          {
            label: 'åŒ¯å‡ºé€²åº¦å‚™ä»½',
            onClick: () => this.exportUserData()
          },
          {
            label: 'æ¸…é™¤èˆŠè³‡æ–™',
            onClick: () => this.clearOldData()
          }
        ]
      });
    });

    // ç¶²è·¯éŒ¯èª¤
    this.registerHandler('network', (error) => {
      this.showFriendlyError({
        emoji: 'ğŸŒâŒ',
        title: 'ç¶²è·¯è¿·è·¯äº†...',
        message: 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚',
        suggestions: [
          'ç¢ºèªç¶²è·¯æ˜¯å¦æ­£å¸¸',
          'ç¨å¾Œå†è©¦',
          'æª¢æŸ¥æ˜¯å¦è¢«é˜²ç«ç‰†é˜»æ“‹'
        ],
        debugInfo: error.message
      });
    });

    // è³‡æ–™é©—è­‰å¤±æ•—
    this.registerHandler('validation', (error) => {
      this.showFriendlyError({
        emoji: 'âš ï¸',
        title: 'è³‡æ–™æ ¼å¼æœ‰èª¤...',
        message: 'é—œå¡è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œå¯èƒ½æ˜¯æª”æ¡ˆæå£ã€‚',
        suggestions: [
          'å˜—è©¦é‡æ–°è¼‰å…¥',
          'æ¸…é™¤å¿«å–å¾Œé‡è©¦',
          'å›å ±æ­¤å•é¡Œçµ¦é–‹ç™¼è€…'
        ],
        debugInfo: error.message
      });
    });
  }

  /**
   * è¨»å†ŠéŒ¯èª¤è™•ç†å™¨
   */
  registerHandler(type: string, handler: (error: ErrorContext) => void): void {
    this.errorHandlers.set(type, handler);
  }

  /**
   * è™•ç†éŒ¯èª¤
   */
  handleError(error: ErrorContext): void {
    // è¨˜éŒ„åˆ° consoleï¼ˆè©³ç´°ï¼‰
    console.error('ErrorBoundary caught error:', {
      type: error.type,
      message: error.message,
      error: error.originalError,
      stack: error.originalError?.stack,
      userState: error.userState,
      timestamp: new Date(error.timestamp).toISOString()
    });

    // åŠ å…¥éŒ¯èª¤æ—¥èªŒ
    this.errorLog.push(error);
    if (this.errorLog.length > this.maxLogSize) {
      this.errorLog.shift();
    }

    // åŸ·è¡Œç‰¹å®šè™•ç†å™¨
    const handler = this.errorHandlers.get(error.type);
    if (handler) {
      handler(error);
    } else {
      // ä½¿ç”¨é è¨­è™•ç†å™¨
      this.showDefaultError(error);
    }

    // ç™¼é€äº‹ä»¶ï¼ˆä¾›å…¶ä»–æ¨¡çµ„ç›£è½ï¼‰
    EventBus.emit('error:occurred', error);
  }

  /**
   * é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
   */
  private showFriendlyError(config: FriendlyErrorConfig): void {
    const container = document.createElement('div');
    container.className = 'error-boundary-overlay';

    container.innerHTML = `
      <div class="error-boundary-card">
        <div class="error-emoji">${config.emoji}</div>
        <h2 class="error-title">${config.title}</h2>
        <p class="error-message">${config.message}</p>

        ${config.suggestions ? `
          <div class="error-suggestions">
            <h3>ä½ å¯ä»¥è©¦è©¦ï¼š</h3>
            <ul>
              ${config.suggestions.map(s => `<li>${s}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${config.actions ? `
          <div class="error-actions">
            ${config.actions.map(action => `
              <button class="error-action-btn" data-action="${action.label}">
                ${action.label}
              </button>
            `).join('')}
          </div>
        ` : ''}

        <button class="error-close-btn">é—œé–‰</button>

        ${GameConfig.dev.debug && config.debugInfo ? `
          <details class="error-debug">
            <summary>Debug è³‡è¨Š</summary>
            <pre>${config.debugInfo}</pre>
          </details>
        ` : ''}
      </div>
    `;

    // ç¶å®šäº‹ä»¶
    container.querySelector('.error-close-btn')?.addEventListener('click', () => {
      container.remove();
    });

    config.actions?.forEach(action => {
      container.querySelector(`[data-action="${action.label}"]`)?.addEventListener('click', () => {
        action.onClick();
        container.remove();
      });
    });

    document.body.appendChild(container);
  }

  /**
   * é¡¯ç¤ºé è¨­éŒ¯èª¤
   */
  private showDefaultError(error: ErrorContext): void {
    this.showFriendlyError({
      emoji: 'ğŸ˜±',
      title: 'å“å‘€ï¼å‡ºéŒ¯äº†...',
      message: 'éŠæˆ²é‡åˆ°äº†ä¸€äº›å•é¡Œï¼Œä½†åˆ¥æ“”å¿ƒï¼Œä½ çš„é€²åº¦å·²ç¶“ä¿å­˜ã€‚',
      suggestions: [
        'é‡æ–°æ•´ç†é é¢',
        'æ¸…é™¤ç€è¦½å™¨å¿«å–',
        'å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹å›å ±çµ¦åš•åš•ä¸»äºº'
      ],
      debugInfo: error.message
    });
  }

  /**
   * å®‰å…¨åŸ·è¡Œå‡½æ•¸ï¼ˆè‡ªå‹•æ•ç²éŒ¯èª¤ï¼‰
   */
  async safeExecute<T>(
    fn: () => Promise<T> | T,
    errorType: ErrorContext['type'] = 'unknown',
    context?: any
  ): Promise<T | null> {
    try {
      return await fn();
    } catch (error) {
      this.handleError({
        type: errorType,
        message: error.message || 'åŸ·è¡Œå¤±æ•—',
        originalError: error as Error,
        timestamp: Date.now(),
        userState: context
      });
      return null;
    }
  }

  /**
   * åŒ¯å‡ºç”¨æˆ¶è³‡æ–™
   */
  private exportUserData(): void {
    const data = Storage.export();
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `seo-quest-backup-${Date.now()}.json`;
    a.click();

    URL.revokeObjectURL(url);
  }

  /**
   * æ¸…é™¤èˆŠè³‡æ–™
   */
  private clearOldData(): void {
    if (confirm('ç¢ºå®šè¦æ¸…é™¤èˆŠè³‡æ–™å—ï¼Ÿå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼')) {
      Storage.clear();
      window.location.reload();
    }
  }

  /**
   * ç²å–éŒ¯èª¤æ—¥èªŒ
   */
  getErrorLog(): ErrorContext[] {
    return [...this.errorLog];
  }
}

// å…¨åŸŸå–®ä¾‹
export const ErrorBoundary = new ErrorBoundary();

// è¼”åŠ©å‹åˆ¥
interface FriendlyErrorConfig {
  emoji: string;
  title: string;
  message: string;
  suggestions?: string[];
  debugInfo?: string;
  actions?: Array<{
    label: string;
    onClick: () => void;
  }>;
}
```

**CSS æ¨£å¼**ï¼š

```css
/* css/components/error-boundary.css */

.error-boundary-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease;
}

.error-boundary-card {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--spacing-2xl);
  max-width: 500px;
  text-align: center;
  box-shadow: var(--shadow-2xl);
  animation: slideUp 0.4s ease;
}

.error-emoji {
  font-size: 4rem;
  margin-bottom: var(--spacing-lg);
  animation: bounce 0.6s ease;
}

.error-title {
  color: var(--color-text-primary);
  font-size: var(--font-size-2xl);
  margin-bottom: var(--spacing-md);
}

.error-message {
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xl);
  line-height: 1.6;
}

.error-suggestions {
  text-align: left;
  background: var(--color-background);
  padding: var(--spacing-lg);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-xl);
}

.error-suggestions h3 {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-sm);
}

.error-suggestions ul {
  list-style: none;
  padding: 0;
}

.error-suggestions li {
  padding: var(--spacing-xs) 0;
  padding-left: var(--spacing-lg);
  position: relative;
}

.error-suggestions li::before {
  content: 'ğŸ’¡';
  position: absolute;
  left: 0;
}

.error-actions {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.error-action-btn {
  flex: 1;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: var(--font-size-sm);
  transition: all 0.2s;
}

.error-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.error-close-btn {
  width: 100%;
  padding: var(--spacing-md);
  background: var(--color-text-tertiary);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: var(--font-size-base);
  transition: all 0.2s;
}

.error-close-btn:hover {
  background: var(--color-text-secondary);
}

.error-debug {
  margin-top: var(--spacing-lg);
  text-align: left;
  font-size: var(--font-size-xs);
}

.error-debug pre {
  background: var(--color-background);
  padding: var(--spacing-md);
  border-radius: var(--radius-sm);
  overflow-x: auto;
  color: var(--color-danger);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```typescript
// åœ¨ JSONLoader ä¸­ä½¿ç”¨
async loadLevel(levelId: string): Promise<LevelData | null> {
  return ErrorBoundary.safeExecute(
    async () => {
      const response = await fetch(`data/levels/${levelId}.json`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    },
    'json-load'
  );
}

// åœ¨ StorageManager ä¸­ä½¿ç”¨
save(data: UserPersistedData): void {
  try {
    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
  } catch (error) {
    if (error.name === 'QuotaExceededError') {
      ErrorBoundary.handleError({
        type: 'storage-quota',
        message: 'localStorage å®¹é‡ä¸è¶³',
        originalError: error,
        timestamp: Date.now()
      });
    }
  }
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/error-boundary.ts`
- `css/components/error-boundary.css`

---

### ğŸ“¦ å»ºè­° #22ï¼šResourceLoader è³‡æºé è¼‰å…¥

**ç›®çš„**ï¼šåœ¨éŠæˆ²åˆå§‹åŒ–å‰é è¼‰é—œéµè³‡æºï¼Œé¡¯ç¤ºè¼‰å…¥é€²åº¦

```typescript
// js/core/resource-loader.ts

interface ResourceManifest {
  critical: string[];      // å¿…é ˆè¼‰å…¥
  important: string[];     // é‡è¦ä½†å¯å»¶å¾Œ
  optional: string[];      // å¯é¸
}

interface LoadProgress {
  total: number;
  loaded: number;
  failed: number;
  progress: number;  // 0-100
  currentResource: string;
}

class ResourceLoader {
  private manifest: ResourceManifest;
  private loadedResources: Map<string, any> = new Map();
  private onProgressCallback?: (progress: LoadProgress) => void;

  constructor() {
    this.manifest = this.createManifest();
  }

  /**
   * å»ºç«‹è³‡æºæ¸…å–®
   */
  private createManifest(): ResourceManifest {
    return {
      critical: [
        'data/levels/world-1/1-1.json',    // ç¬¬ä¸€é—œ
        'data/characters.json',             // è§’è‰²è³‡æ–™
        'data/assets-config.json',          // è³‡æºé…ç½®
        'data/scoring-rules.json'           // è©•åˆ†è¦å‰‡
      ],
      important: [
        'data/achievements.json',
        'data/levels/world-1/1-2.json',
        'data/levels/world-1/1-3.json'
      ],
      optional: [
        'data/levels/world-2/2-1.json',
        'data/levels/world-3/3-1.json'
      ]
    };
  }

  /**
   * è¼‰å…¥é—œéµè³‡æº
   */
  async loadCritical(onProgress?: (progress: LoadProgress) => void): Promise<boolean> {
    this.onProgressCallback = onProgress;

    const resources = this.manifest.critical;
    const total = resources.length;
    let loaded = 0;
    let failed = 0;

    // é¡¯ç¤ºè¼‰å…¥ç•«é¢
    this.showLoadingScreen();

    for (const resource of resources) {
      this.updateProgress({
        total,
        loaded,
        failed,
        progress: (loaded / total) * 100,
        currentResource: resource
      });

      try {
        const data = await this.loadResource(resource);
        this.loadedResources.set(resource, data);
        loaded++;
      } catch (error) {
        console.error(`Failed to load ${resource}:`, error);
        failed++;

        // é—œéµè³‡æºè¼‰å…¥å¤±æ•— â†’ é¡¯ç¤ºéŒ¯èª¤
        ErrorBoundary.handleError({
          type: 'json-load',
          message: `ç„¡æ³•è¼‰å…¥é—œéµè³‡æºï¼š${resource}`,
          originalError: error as Error,
          timestamp: Date.now()
        });

        return false;
      }
    }

    // å®Œæˆ
    this.updateProgress({
      total,
      loaded,
      failed,
      progress: 100,
      currentResource: 'è¼‰å…¥å®Œæˆï¼'
    });

    // å»¶é² 500ms è®“ä½¿ç”¨è€…çœ‹åˆ° 100%
    await this.delay(500);
    this.hideLoadingScreen();

    return failed === 0;
  }

  /**
   * èƒŒæ™¯è¼‰å…¥é‡è¦è³‡æº
   */
  async loadImportantInBackground(): Promise<void> {
    const resources = this.manifest.important;

    for (const resource of resources) {
      try {
        const data = await this.loadResource(resource);
        this.loadedResources.set(resource, data);
        console.log(`âœ… Background loaded: ${resource}`);
      } catch (error) {
        console.warn(`âš ï¸ Background load failed: ${resource}`, error);
        // é‡è¦è³‡æºå¤±æ•—ä¸å½±éŸ¿éŠæˆ²é‹è¡Œ
      }
    }
  }

  /**
   * è¼‰å…¥å–®ä¸€è³‡æº
   */
  private async loadResource(path: string): Promise<any> {
    const response = await fetch(path);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    return response.json();
  }

  /**
   * ç²å–å·²è¼‰å…¥çš„è³‡æº
   */
  getResource<T>(path: string): T | null {
    return this.loadedResources.get(path) || null;
  }

  /**
   * æª¢æŸ¥è³‡æºæ˜¯å¦å·²è¼‰å…¥
   */
  isLoaded(path: string): boolean {
    return this.loadedResources.has(path);
  }

  /**
   * é¡¯ç¤ºè¼‰å…¥ç•«é¢
   */
  private showLoadingScreen(): void {
    const container = document.createElement('div');
    container.id = 'resource-loader';
    container.className = 'resource-loader-overlay';

    container.innerHTML = `
      <div class="resource-loader-content">
        <div class="loader-logo">âš”ï¸ SEO Quest</div>
        <h2 class="loader-title">æº–å‚™å†’éšªä¸­...</h2>

        <div class="loader-progress-bar">
          <div class="loader-progress-fill" id="loader-progress-fill"></div>
        </div>

        <p class="loader-status" id="loader-status">è¼‰å…¥ä¸­...</p>
        <p class="loader-percentage" id="loader-percentage">0%</p>
      </div>
    `;

    document.body.appendChild(container);
  }

  /**
   * æ›´æ–°è¼‰å…¥é€²åº¦
   */
  private updateProgress(progress: LoadProgress): void {
    const fillEl = document.getElementById('loader-progress-fill');
    const statusEl = document.getElementById('loader-status');
    const percentageEl = document.getElementById('loader-percentage');

    if (fillEl) {
      fillEl.style.width = `${progress.progress}%`;
    }

    if (statusEl) {
      const resourceName = progress.currentResource.split('/').pop();
      statusEl.textContent = `è¼‰å…¥ï¼š${resourceName}`;
    }

    if (percentageEl) {
      percentageEl.textContent = `${Math.round(progress.progress)}%`;
    }

    // å‘¼å«å¤–éƒ¨å›èª¿
    this.onProgressCallback?.(progress);
  }

  /**
   * éš±è—è¼‰å…¥ç•«é¢
   */
  private hideLoadingScreen(): void {
    const loader = document.getElementById('resource-loader');
    if (loader) {
      loader.style.opacity = '0';
      setTimeout(() => loader.remove(), 300);
    }
  }

  /**
   * å»¶é²å‡½æ•¸
   */
  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// å…¨åŸŸå–®ä¾‹
export const ResourceLoader = new ResourceLoader();
```

**CSS æ¨£å¼**ï¼š

```css
/* css/components/resource-loader.css */

.resource-loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  transition: opacity 0.3s ease;
}

.resource-loader-content {
  text-align: center;
  color: white;
  max-width: 400px;
  width: 90%;
}

.loader-logo {
  font-size: 4rem;
  margin-bottom: var(--spacing-md);
  animation: pulse 2s ease-in-out infinite;
}

.loader-title {
  font-size: var(--font-size-2xl);
  margin-bottom: var(--spacing-2xl);
  font-weight: 600;
}

.loader-progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: var(--spacing-lg);
}

.loader-progress-fill {
  width: 0%;
  height: 100%;
  background: white;
  border-radius: 10px;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.loader-status {
  font-size: var(--font-size-sm);
  opacity: 0.8;
  margin-bottom: var(--spacing-xs);
}

.loader-percentage {
  font-size: var(--font-size-xl);
  font-weight: 700;
  font-family: 'Courier New', monospace;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}
```

**ä½¿ç”¨ç¯„ä¾‹ï¼ˆåœ¨ main.jsï¼‰**ï¼š

```typescript
// js/main.js

import { ResourceLoader } from './core/resource-loader.js';
import { GameConfig } from './config/game-config.js';

async function init() {
  // è¼‰å…¥é—œéµè³‡æº
  const success = await ResourceLoader.loadCritical((progress) => {
    console.log(`è¼‰å…¥é€²åº¦ï¼š${progress.progress}%`);
  });

  if (!success) {
    console.error('è³‡æºè¼‰å…¥å¤±æ•—');
    return;
  }

  // åˆå§‹åŒ–éŠæˆ²
  initializeGame();

  // èƒŒæ™¯è¼‰å…¥å…¶ä»–è³‡æº
  ResourceLoader.loadImportantInBackground();
}

init();
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/resource-loader.ts`
- `css/components/resource-loader.css`

---

### ğŸ“¡ å»ºè­° #23ï¼šEventBus äº‹ä»¶é©…å‹•æ¶æ§‹

**ç›®çš„**ï¼šè§£è€¦ Core é‚è¼¯èˆ‡ UI æ¸²æŸ“ï¼Œä½¿ç”¨ Pub/Sub æ¨¡å¼

```typescript
// js/core/event-bus.ts

type EventCallback = (...args: any[]) => void;

interface EventListener {
  callback: EventCallback;
  once: boolean;
}

class EventBus {
  private events: Map<string, EventListener[]> = new Map();
  private eventHistory: Array<{ event: string; args: any[]; timestamp: number }> = [];
  private maxHistorySize = 50;

  /**
   * è¨‚é–±äº‹ä»¶
   */
  on(event: string, callback: EventCallback): void {
    if (!this.events.has(event)) {
      this.events.set(event, []);
    }

    this.events.get(event)!.push({ callback, once: false });
  }

  /**
   * è¨‚é–±ä¸€æ¬¡æ€§äº‹ä»¶
   */
  once(event: string, callback: EventCallback): void {
    if (!this.events.has(event)) {
      this.events.set(event, []);
    }

    this.events.get(event)!.push({ callback, once: true });
  }

  /**
   * å–æ¶ˆè¨‚é–±
   */
  off(event: string, callback?: EventCallback): void {
    if (!this.events.has(event)) return;

    if (callback) {
      // ç§»é™¤ç‰¹å®šå›èª¿
      const listeners = this.events.get(event)!;
      this.events.set(
        event,
        listeners.filter(listener => listener.callback !== callback)
      );
    } else {
      // ç§»é™¤æ‰€æœ‰ç›£è½å™¨
      this.events.delete(event);
    }
  }

  /**
   * ç™¼å¸ƒäº‹ä»¶
   */
  emit(event: string, ...args: any[]): void {
    // è¨˜éŒ„æ­·å²ï¼ˆé™¤éæ˜¯é«˜é »äº‹ä»¶ï¼‰
    if (!this.isHighFrequencyEvent(event)) {
      this.eventHistory.push({
        event,
        args,
        timestamp: Date.now()
      });

      if (this.eventHistory.length > this.maxHistorySize) {
        this.eventHistory.shift();
      }
    }

    // Debug æ¨¡å¼è¨˜éŒ„
    if (GameConfig.dev.debug) {
      console.log(`[EventBus] ${event}`, args);
    }

    // åŸ·è¡Œç›£è½å™¨
    if (!this.events.has(event)) return;

    const listeners = this.events.get(event)!;
    const listenersToRemove: EventListener[] = [];

    listeners.forEach(listener => {
      try {
        listener.callback(...args);

        // æ¨™è¨˜ä¸€æ¬¡æ€§ç›£è½å™¨
        if (listener.once) {
          listenersToRemove.push(listener);
        }
      } catch (error) {
        console.error(`[EventBus] Error in listener for ${event}:`, error);
      }
    });

    // ç§»é™¤ä¸€æ¬¡æ€§ç›£è½å™¨
    if (listenersToRemove.length > 0) {
      this.events.set(
        event,
        listeners.filter(l => !listenersToRemove.includes(l))
      );
    }
  }

  /**
   * æª¢æŸ¥æ˜¯å¦ç‚ºé«˜é »äº‹ä»¶ï¼ˆä¸è¨˜éŒ„æ­·å²ï¼‰
   */
  private isHighFrequencyEvent(event: string): boolean {
    const highFrequencyEvents = [
      'scroll',
      'mousemove',
      'resize',
      'typewriter:char'
    ];
    return highFrequencyEvents.includes(event);
  }

  /**
   * ç²å–äº‹ä»¶æ­·å²
   */
  getHistory(): Array<{ event: string; args: any[]; timestamp: number }> {
    return [...this.eventHistory];
  }

  /**
   * æ¸…ç©ºäº‹ä»¶æ­·å²
   */
  clearHistory(): void {
    this.eventHistory = [];
  }

  /**
   * åˆ—å‡ºæ‰€æœ‰å·²è¨»å†Šçš„äº‹ä»¶
   */
  listEvents(): string[] {
    return Array.from(this.events.keys());
  }

  /**
   * ç²å–äº‹ä»¶çš„ç›£è½å™¨æ•¸é‡
   */
  getListenerCount(event: string): number {
    return this.events.get(event)?.length || 0;
  }
}

// å…¨åŸŸå–®ä¾‹
export const EventBus = new EventBus();

// ==================== äº‹ä»¶å®šç¾© ====================

/**
 * äº‹ä»¶åç¨±å¸¸æ•¸ï¼ˆé¿å…æ‹¼å¯«éŒ¯èª¤ï¼‰
 */
export const Events = {
  // éšæ®µç›¸é—œ
  PHASE_CHANGED: 'phase:changed',
  PHASE_COMPLETED: 'phase:completed',

  // ç¶“é©—å€¼ç›¸é—œ
  EXP_CHANGED: 'exp:changed',
  LEVEL_UP: 'level:up',

  // é—œå¡ç›¸é—œ
  LEVEL_STARTED: 'level:started',
  LEVEL_COMPLETED: 'level:completed',

  // è©•åˆ†ç›¸é—œ
  SCORE_CALCULATED: 'score:calculated',
  GRADE_ACHIEVED: 'grade:achieved',

  // æˆå°±ç›¸é—œ
  ACHIEVEMENT_UNLOCKED: 'achievement:unlocked',
  TOOL_UNLOCKED: 'tool:unlocked',
  NOTE_UNLOCKED: 'note:unlocked',

  // UI ç›¸é—œ
  TOAST_SHOW: 'toast:show',
  MODAL_OPEN: 'modal:open',
  MODAL_CLOSE: 'modal:close',

  // è³‡æ–™ç›¸é—œ
  USER_DATA_LOADED: 'user:data:loaded',
  USER_DATA_SAVED: 'user:data:saved',

  // éŒ¯èª¤ç›¸é—œ
  ERROR_OCCURRED: 'error:occurred'
} as const;
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```typescript
// ==================== åœ¨ Core å±¤ç™¼å¸ƒäº‹ä»¶ ====================

// js/core/user-state-manager.ts
class UserStateManager {
  addExp(amount: number): void {
    const oldExp = this.state.exp;
    const oldLevel = this.state.level;

    this.state.exp += amount;

    // ç™¼å¸ƒç¶“é©—å€¼è®Šæ›´äº‹ä»¶
    EventBus.emit(Events.EXP_CHANGED, {
      oldExp,
      newExp: this.state.exp,
      gained: amount
    });

    // æª¢æŸ¥æ˜¯å¦å‡ç´š
    if (this.state.level > oldLevel) {
      EventBus.emit(Events.LEVEL_UP, {
        oldLevel,
        newLevel: this.state.level,
        newTitle: getLevelTitle(this.state.level)
      });
    }
  }
}

// ==================== åœ¨ UI å±¤è¨‚é–±äº‹ä»¶ ====================

// js/ui/dashboard.ts
class Dashboard {
  constructor() {
    this.bindEvents();
  }

  private bindEvents(): void {
    // ç›£è½ç¶“é©—å€¼è®Šæ›´
    EventBus.on(Events.EXP_CHANGED, (data) => {
      this.animateExpBar(data.oldExp, data.newExp);
      this.showExpGain(data.gained);
    });

    // ç›£è½å‡ç´š
    EventBus.on(Events.LEVEL_UP, (data) => {
      this.showLevelUpCelebration(data.newLevel, data.newTitle);
      this.updateLevelDisplay(data.newLevel);
    });

    // ç›£è½æˆå°±è§£é–
    EventBus.on(Events.ACHIEVEMENT_UNLOCKED, (achievement) => {
      this.showAchievementToast(achievement);
    });
  }

  private animateExpBar(oldExp: number, newExp: number): void {
    // åªè™•ç† UIï¼Œä¸æ“ä½œç‹€æ…‹
    const expBar = document.querySelector('.exp-bar-fill');
    // ... å‹•ç•«é‚è¼¯
  }
}

// ==================== åœ¨ Service å±¤è¨‚é–±äº‹ä»¶ ====================

// js/services/analytics.ts (æœªä¾†æ“´å……)
class Analytics {
  constructor() {
    this.trackEvents();
  }

  private trackEvents(): void {
    EventBus.on(Events.LEVEL_COMPLETED, (data) => {
      // ç™¼é€æ•¸æ“šåˆ°åˆ†ææœå‹™
      this.track('level_completed', {
        levelId: data.levelId,
        score: data.score,
        attempts: data.attempts
      });
    });

    EventBus.on(Events.ACHIEVEMENT_UNLOCKED, (achievement) => {
      this.track('achievement_unlocked', {
        achievementId: achievement.id
      });
    });
  }
}
```

**å„ªå‹¢**ï¼š
1. **è§£è€¦**ï¼šCore ä¸éœ€è¦çŸ¥é“ UI å¦‚ä½•æ¸²æŸ“
2. **æ“´å……æ€§**ï¼šæ–°å¢åŠŸèƒ½åªéœ€è¨‚é–±äº‹ä»¶
3. **å¯æ¸¬è©¦æ€§**ï¼šå¯ä»¥æ¨¡æ“¬äº‹ä»¶é€²è¡Œæ¸¬è©¦
4. **å¯ç¶­è­·æ€§**ï¼šäº‹ä»¶åç¨±çµ±ä¸€ç®¡ç†

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/event-bus.ts`
- `js/constants/events.ts`ï¼ˆäº‹ä»¶åç¨±å¸¸æ•¸ï¼‰

---

### ğŸ“ å»ºè­° #24ï¼šJSDoc å‹åˆ¥è¨»é‡‹

**ç›®çš„**ï¼šç‚ºæ ¸å¿ƒé¡åˆ¥æ·»åŠ å®Œæ•´ JSDocï¼Œæä¾› IDE è‡ªå‹•å®Œæˆ

```typescript
// js/core/router.ts

/**
 * è·¯ç”±ç®¡ç†å™¨
 *
 * è² è²¬ç®¡ç†éšæ®µåˆ‡æ›ã€æ­·å²è¨˜éŒ„å’Œå‹•æ…‹è¼‰å…¥
 *
 * @class Router
 * @example
 * ```typescript
 * const router = new Router();
 * await router.navigateTo('1-1', 'tutorial');
 * ```
 */
class Router {
  /**
   * ç•¶å‰è·¯ç”±ç‹€æ…‹
   * @type {RouteState}
   * @private
   */
  private currentRoute: RouteState;

  /**
   * è·¯ç”±æ­·å²è¨˜éŒ„
   * @type {RouteState[]}
   * @private
   */
  private history: RouteState[] = [];

  /**
   * éšæ®µç‹€æ…‹æ©Ÿ
   * @type {PhaseStateMachine}
   * @private
   */
  private fsm: PhaseStateMachine;

  /**
   * å»ºç«‹è·¯ç”±ç®¡ç†å™¨
   * @param {RouteState} [initialRoute] - åˆå§‹è·¯ç”±
   */
  constructor(initialRoute?: RouteState) {
    this.currentRoute = initialRoute || this.getDefaultRoute();
    this.fsm = new PhaseStateMachine(this.currentRoute.phase);
  }

  /**
   * å°èˆªåˆ°æŒ‡å®šé—œå¡å’Œéšæ®µ
   *
   * @param {string} levelId - é—œå¡ IDï¼ˆä¾‹å¦‚ï¼š'1-1'ï¼‰
   * @param {PhaseState} phase - éšæ®µåç¨±
   * @param {boolean} [skipTransition=false] - æ˜¯å¦è·³éè½‰å ´å‹•ç•«
   * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸå°èˆª
   *
   * @example
   * ```typescript
   * // å°èˆªåˆ° 1-1 é—œå¡çš„ tutorial éšæ®µ
   * await router.navigateTo('1-1', 'tutorial');
   *
   * // è·³éè½‰å ´å‹•ç•«
   * await router.navigateTo('1-2', 'practice', true);
   * ```
   */
  async navigateTo(
    levelId: string,
    phase: PhaseState,
    skipTransition: boolean = false
  ): Promise<boolean> {
    // æª¢æŸ¥æ˜¯å¦ç‚ºåˆæ³•è½‰æ›
    if (!this.fsm.canTransition(PhaseEvent.NEXT)) {
      console.warn('Invalid phase transition');
      return false;
    }

    // è¼‰å…¥é—œå¡è³‡æ–™
    const levelData = await this.loadLevel(levelId);
    if (!levelData) {
      return false;
    }

    // è¨˜éŒ„æ­·å²
    this.history.push(this.currentRoute);

    // æ›´æ–°è·¯ç”±
    this.currentRoute = { levelId, phase, data: levelData };

    // åŸ·è¡Œè½‰å ´
    if (!skipTransition) {
      await this.performTransition(phase);
    }

    // æ¸²æŸ“æ–°éšæ®µ
    this.render();

    // ç™¼å¸ƒäº‹ä»¶
    EventBus.emit(Events.PHASE_CHANGED, { levelId, phase });

    return true;
  }

  /**
   * è¿”å›ä¸Šä¸€å€‹è·¯ç”±
   * @returns {boolean} æ˜¯å¦æˆåŠŸè¿”å›
   */
  goBack(): boolean {
    if (this.history.length === 0) {
      return false;
    }

    this.currentRoute = this.history.pop()!;
    this.render();
    return true;
  }

  /**
   * è¼‰å…¥é—œå¡è³‡æ–™ï¼ˆä½¿ç”¨å‹•æ…‹ importï¼‰
   *
   * @param {string} levelId - é—œå¡ ID
   * @returns {Promise<LevelData | null>} é—œå¡è³‡æ–™
   * @private
   */
  private async loadLevel(levelId: string): Promise<LevelData | null> {
    // æª¢æŸ¥å¿«å–
    if (ResourceLoader.isLoaded(`data/levels/${levelId}.json`)) {
      return ResourceLoader.getResource(`data/levels/${levelId}.json`);
    }

    // å‹•æ…‹è¼‰å…¥
    try {
      const module = await import(`../data/levels/world-1/${levelId}.json`);
      return module.default;
    } catch (error) {
      ErrorBoundary.handleError({
        type: 'json-load',
        message: `ç„¡æ³•è¼‰å…¥é—œå¡ï¼š${levelId}`,
        originalError: error as Error,
        timestamp: Date.now()
      });
      return null;
    }
  }

  /**
   * åŸ·è¡Œè½‰å ´å‹•ç•«
   * @param {PhaseState} phase - ç›®æ¨™éšæ®µ
   * @returns {Promise<void>}
   * @private
   */
  private async performTransition(phase: PhaseState): Promise<void> {
    // å¯¦ä½œè½‰å ´é‚è¼¯
  }

  /**
   * æ¸²æŸ“ç•¶å‰éšæ®µ
   * @private
   */
  private render(): void {
    // å¯¦ä½œæ¸²æŸ“é‚è¼¯
  }

  /**
   * ç²å–é è¨­è·¯ç”±
   * @returns {RouteState}
   * @private
   */
  private getDefaultRoute(): RouteState {
    return {
      levelId: '1-1',
      phase: PhaseState.TUTORIAL,
      data: null
    };
  }
}

// ==================== å‹åˆ¥å®šç¾© ====================

/**
 * è·¯ç”±ç‹€æ…‹
 * @typedef {Object} RouteState
 * @property {string} levelId - é—œå¡ ID
 * @property {PhaseState} phase - ç•¶å‰éšæ®µ
 * @property {LevelData | null} data - é—œå¡è³‡æ–™
 */
interface RouteState {
  levelId: string;
  phase: PhaseState;
  data: LevelData | null;
}

/**
 * é—œå¡è³‡æ–™çµæ§‹
 * @typedef {Object} LevelData
 * @property {string} id - é—œå¡ ID
 * @property {string} title - é—œå¡æ¨™é¡Œ
 * @property {string} version - è³‡æ–™ç‰ˆæœ¬
 * @property {Phase[]} phases - éšæ®µé™£åˆ—
 * @property {Metadata} metadata - å…ƒè³‡æ–™
 */
interface LevelData {
  id: string;
  title: string;
  version: string;
  phases: Phase[];
  metadata: Metadata;
}

/**
 * éšæ®µè³‡æ–™
 * @typedef {Object} Phase
 * @property {string} type - éšæ®µé¡å‹
 * @property {any} content - éšæ®µå…§å®¹
 */
interface Phase {
  type: PhaseState;
  content: any;
}

/**
 * å…ƒè³‡æ–™
 * @typedef {Object} Metadata
 * @property {number} difficulty - é›£åº¦ï¼ˆ1-5ï¼‰
 * @property {number} estimatedTime - é ä¼°æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
 * @property {string[]} tags - æ¨™ç±¤
 */
interface Metadata {
  difficulty: number;
  estimatedTime: number;
  tags: string[];
}
```

**JSDoc ç¯„ä¾‹ï¼ˆState ç®¡ç†ï¼‰**ï¼š

```typescript
/**
 * ç”¨æˆ¶ç‹€æ…‹ç®¡ç†å™¨
 *
 * ç®¡ç†ç”¨æˆ¶ç­‰ç´šã€ç¶“é©—å€¼ã€å®Œæˆé—œå¡ç­‰è³‡æ–™
 * ä½¿ç”¨ Store Pattern å¯¦ä½œï¼Œæ‰€æœ‰è®Šæ›´é€šé dispatch é€²è¡Œ
 *
 * @class UserStateManager
 */
class UserStateManager {
  /**
   * ç”¨æˆ¶æŒä¹…åŒ–è³‡æ–™
   * @type {UserPersistedData}
   * @private
   */
  private state: UserPersistedData;

  /**
   * å¢åŠ ç¶“é©—å€¼
   *
   * @param {number} amount - ç¶“é©—å€¼æ•¸é‡
   * @returns {LevelUpResult | null} å¦‚æœå‡ç´šï¼Œè¿”å›å‡ç´šè³‡è¨Š
   *
   * @example
   * ```typescript
   * const result = userState.addExp(150);
   * if (result) {
   *   console.log(`å‡ç´šåˆ° Lv.${result.newLevel}ï¼`);
   * }
   * ```
   */
  addExp(amount: number): LevelUpResult | null {
    // ...
  }

  /**
   * å®Œæˆé—œå¡
   *
   * @param {CompletedLevel} levelData - é—œå¡å®Œæˆè³‡æ–™
   * @returns {void}
   */
  completeLevel(levelData: CompletedLevel): void {
    // ...
  }

  /**
   * è§£é–æˆå°±
   *
   * @param {string} achievementId - æˆå°± ID
   * @returns {boolean} æ˜¯å¦ç‚ºæ–°è§£é–ï¼ˆé¿å…é‡è¤‡ï¼‰
   */
  unlockAchievement(achievementId: string): boolean {
    // ...
  }
}

/**
 * å‡ç´šçµæœ
 * @typedef {Object} LevelUpResult
 * @property {number} oldLevel - èˆŠç­‰ç´š
 * @property {number} newLevel - æ–°ç­‰ç´š
 * @property {string} newTitle - æ–°ç¨±è™Ÿ
 * @property {string[]} unlockedContent - è§£é–çš„å…§å®¹
 */
interface LevelUpResult {
  oldLevel: number;
  newLevel: number;
  newTitle: string;
  unlockedContent: string[];
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- ç‚ºæ‰€æœ‰ `js/core/*.ts` æ·»åŠ  JSDoc
- ç‚ºæ‰€æœ‰ `js/modules/*.ts` æ·»åŠ  JSDoc
- å»ºç«‹ `js/types/*.ts` å‹åˆ¥å®šç¾©æª”æ¡ˆ

---

### âš¡ å»ºè­° #25ï¼šDynamic Import å‹•æ…‹è¼‰å…¥

**ç›®çš„**ï¼šå»¶é²è¼‰å…¥éé¦–å±æ¨¡çµ„ï¼Œå„ªåŒ–é¦–å±è¼‰å…¥é€Ÿåº¦

```typescript
// js/core/router.ts

class Router {
  /**
   * å‹•æ…‹è¼‰å…¥å·¥å…·æ¨¡å¼æ¨¡çµ„
   */
  async loadToolMode(): Promise<void> {
    // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥
    if (this.toolModeLoaded) {
      return;
    }

    try {
      // å‹•æ…‹è¼‰å…¥å·¥å…·æ¨¡å¼ç›¸é—œæ¨¡çµ„
      const [
        { ToolModeUI },
        { SEOAnalyzer },
        { KeywordSuggester },
        { FactChecker }
      ] = await Promise.all([
        import('../ui/tool-mode-ui.js'),
        import('../modules/seo-analyzer.js'),
        import('../modules/keyword-suggester.js'),
        import('../modules/fact-checker.js')
      ]);

      // åˆå§‹åŒ–å·¥å…·æ¨¡å¼
      this.toolMode = new ToolModeUI();
      this.toolMode.init();

      this.toolModeLoaded = true;
      console.log('âœ… Tool Mode loaded');
    } catch (error) {
      console.error('Failed to load Tool Mode:', error);
      ErrorBoundary.handleError({
        type: 'unknown',
        message: 'å·¥å…·æ¨¡å¼è¼‰å…¥å¤±æ•—',
        originalError: error as Error,
        timestamp: Date.now()
      });
    }
  }

  /**
   * å‹•æ…‹è¼‰å…¥ä¸–ç•Œè³‡æ–™
   */
  async loadWorld(worldId: number): Promise<WorldData | null> {
    try {
      // æ ¹æ“šä¸–ç•Œ ID å‹•æ…‹è¼‰å…¥
      const module = await import(`../data/levels/world-${worldId}/index.js`);
      return module.default;
    } catch (error) {
      console.error(`Failed to load world ${worldId}:`, error);
      return null;
    }
  }

  /**
   * é è¼‰å…¥ä¸‹ä¸€é—œï¼ˆæå‰è¼‰å…¥ï¼‰
   */
  async preloadNextLevel(currentLevelId: string): Promise<void> {
    const nextLevelId = this.getNextLevelId(currentLevelId);

    if (nextLevelId) {
      // èƒŒæ™¯è¼‰å…¥ï¼Œä¸é˜»å¡
      import(`../data/levels/world-1/${nextLevelId}.json`)
        .then(module => {
          console.log(`âœ… Preloaded: ${nextLevelId}`);
        })
        .catch(error => {
          console.warn(`âš ï¸ Preload failed: ${nextLevelId}`, error);
        });
    }
  }
}
```

**æ¨¡çµ„çµ„ç¹”ç¯„ä¾‹**ï¼š

```typescript
// js/data/levels/world-1/index.js
// ä¸–ç•Œç´¢å¼•æª”æ¡ˆï¼Œæ–¹ä¾¿å‹•æ…‹è¼‰å…¥

export default {
  id: 1,
  name: 'SEO åŸºç¤ç‹åœ‹',
  levels: [
    '1-1',
    '1-2',
    '1-3',
    '1-4',
    '1-boss'
  ],
  requiredLevel: 1,
  description: 'å­¸ç¿’ SEO æ–‡æ¡ˆçš„åŸºç¤çŸ¥è­˜'
};

// ä¹Ÿå¯ä»¥å»¶é²è¼‰å…¥é—œå¡æ¸…å–®
export async function loadAllLevels() {
  const modules = await Promise.all([
    import('./1-1.json'),
    import('./1-2.json'),
    import('./1-3.json'),
    import('./1-4.json'),
    import('./1-boss.json')
  ]);

  return modules.map(m => m.default);
}
```

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- åœ¨ `js/core/router.ts` å¯¦ä½œå‹•æ…‹è¼‰å…¥
- å»ºç«‹ `js/data/levels/world-*/index.js` ç´¢å¼•æª”æ¡ˆ

---

### ğŸª å»ºè­° #26ï¼šStore Pattern ç‹€æ…‹ç®¡ç†

**ç›®çš„**ï¼šä½¿ç”¨ Redux-like æ¨¡å¼é›†ä¸­ç®¡ç†ç‹€æ…‹è®Šæ›´

```typescript
// js/core/store.ts

/**
 * Action é¡å‹
 */
export const ActionTypes = {
  // ç¶“é©—å€¼
  ADD_EXP: 'ADD_EXP',
  SET_LEVEL: 'SET_LEVEL',

  // é—œå¡
  START_LEVEL: 'START_LEVEL',
  COMPLETE_LEVEL: 'COMPLETE_LEVEL',

  // éšæ®µ
  CHANGE_PHASE: 'CHANGE_PHASE',

  // æˆå°±
  UNLOCK_ACHIEVEMENT: 'UNLOCK_ACHIEVEMENT',
  UNLOCK_TOOL: 'UNLOCK_TOOL',

  // è¨­å®š
  UPDATE_SETTINGS: 'UPDATE_SETTINGS',

  // è³‡æ–™
  LOAD_DATA: 'LOAD_DATA',
  RESET_DATA: 'RESET_DATA'
} as const;

/**
 * Action ä»‹é¢
 */
interface Action {
  type: string;
  payload?: any;
}

/**
 * Reducer å‡½æ•¸
 */
type Reducer<S> = (state: S, action: Action) => S;

/**
 * Store é¡åˆ¥
 */
class Store<S> {
  private state: S;
  private reducer: Reducer<S>;
  private listeners: Array<(state: S) => void> = [];

  constructor(reducer: Reducer<S>, initialState: S) {
    this.reducer = reducer;
    this.state = initialState;
  }

  /**
   * ç²å–ç•¶å‰ç‹€æ…‹ï¼ˆå”¯è®€ï¼‰
   */
  getState(): Readonly<S> {
    return Object.freeze({ ...this.state });
  }

  /**
   * æ´¾ç™¼ Action
   */
  dispatch(action: Action): void {
    // Debug æ¨¡å¼è¨˜éŒ„
    if (GameConfig.dev.debug) {
      console.log('[Store] Dispatch:', action);
    }

    // åŸ·è¡Œ reducer ç²å–æ–°ç‹€æ…‹
    const newState = this.reducer(this.state, action);

    // æª¢æŸ¥ç‹€æ…‹æ˜¯å¦è®Šæ›´
    if (newState !== this.state) {
      this.state = newState;

      // è‡ªå‹•å„²å­˜
      this.autoSave();

      // é€šçŸ¥ç›£è½å™¨
      this.notifyListeners();

      // ç™¼é€äº‹ä»¶
      this.emitEvent(action);
    }
  }

  /**
   * è¨‚é–±ç‹€æ…‹è®Šæ›´
   */
  subscribe(listener: (state: S) => void): () => void {
    this.listeners.push(listener);

    // è¿”å›å–æ¶ˆè¨‚é–±å‡½æ•¸
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  }

  /**
   * é€šçŸ¥æ‰€æœ‰ç›£è½å™¨
   */
  private notifyListeners(): void {
    this.listeners.forEach(listener => {
      try {
        listener(this.getState());
      } catch (error) {
        console.error('[Store] Listener error:', error);
      }
    });
  }

  /**
   * è‡ªå‹•å„²å­˜
   */
  private autoSave(): void {
    Storage.save(this.state as any);
  }

  /**
   * ç™¼é€å°æ‡‰çš„ EventBus äº‹ä»¶
   */
  private emitEvent(action: Action): void {
    switch (action.type) {
      case ActionTypes.ADD_EXP:
        EventBus.emit(Events.EXP_CHANGED, action.payload);
        break;

      case ActionTypes.COMPLETE_LEVEL:
        EventBus.emit(Events.LEVEL_COMPLETED, action.payload);
        break;

      case ActionTypes.UNLOCK_ACHIEVEMENT:
        EventBus.emit(Events.ACHIEVEMENT_UNLOCKED, action.payload);
        break;

      // ... å…¶ä»–äº‹ä»¶
    }
  }
}

/**
 * ç”¨æˆ¶ç‹€æ…‹ Reducer
 */
function userReducer(
  state: UserPersistedData,
  action: Action
): UserPersistedData {
  switch (action.type) {
    case ActionTypes.ADD_EXP: {
      const { amount } = action.payload;
      let newExp = state.exp + amount;
      let newLevel = state.level;

      // æª¢æŸ¥å‡ç´š
      while (newExp >= getNextLevelExp(newLevel) && newLevel < GameConfig.level.maxLevel) {
        newExp -= getNextLevelExp(newLevel);
        newLevel++;
      }

      return {
        ...state,
        exp: newExp,
        level: newLevel,
        title: getLevelTitle(newLevel)
      };
    }

    case ActionTypes.COMPLETE_LEVEL: {
      const { levelData } = action.payload;

      return {
        ...state,
        completedLevels: [
          ...state.completedLevels,
          levelData
        ],
        totalCompleted: state.totalCompleted + 1,
        lastPlayedAt: new Date().toISOString()
      };
    }

    case ActionTypes.UNLOCK_ACHIEVEMENT: {
      const { achievementId } = action.payload;

      // é¿å…é‡è¤‡
      if (state.unlockedAchievements.includes(achievementId)) {
        return state;
      }

      return {
        ...state,
        unlockedAchievements: [
          ...state.unlockedAchievements,
          achievementId
        ]
      };
    }

    case ActionTypes.UPDATE_SETTINGS: {
      return {
        ...state,
        settings: {
          ...state.settings,
          ...action.payload
        }
      };
    }

    case ActionTypes.LOAD_DATA: {
      return action.payload;
    }

    case ActionTypes.RESET_DATA: {
      return Storage.createDefaultData();
    }

    default:
      return state;
  }
}

// å»ºç«‹å…¨åŸŸ Store
export const UserStore = new Store(
  userReducer,
  Storage.load()
);

// ==================== Action Creators ====================

/**
 * å¢åŠ ç¶“é©—å€¼
 */
export function addExp(amount: number) {
  UserStore.dispatch({
    type: ActionTypes.ADD_EXP,
    payload: { amount }
  });
}

/**
 * å®Œæˆé—œå¡
 */
export function completeLevel(levelData: CompletedLevel) {
  UserStore.dispatch({
    type: ActionTypes.COMPLETE_LEVEL,
    payload: { levelData }
  });
}

/**
 * è§£é–æˆå°±
 */
export function unlockAchievement(achievementId: string) {
  UserStore.dispatch({
    type: ActionTypes.UNLOCK_ACHIEVEMENT,
    payload: { achievementId }
  });
}

/**
 * æ›´æ–°è¨­å®š
 */
export function updateSettings(settings: Partial<UserSettings>) {
  UserStore.dispatch({
    type: ActionTypes.UPDATE_SETTINGS,
    payload: settings
  });
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```typescript
// ==================== åœ¨ Core å±¤ä½¿ç”¨ ====================

// ä»¥å‰ï¼ˆç›´æ¥ä¿®æ”¹ç‹€æ…‹ï¼‰
State.current.exp = 100;  // âŒ ä¸æ¨è–¦

// ç¾åœ¨ï¼ˆé€šé dispatchï¼‰
addExp(100);  // âœ… æ¨è–¦

// ==================== åœ¨ UI å±¤è¨‚é–± ====================

// js/ui/dashboard.ts
class Dashboard {
  constructor() {
    // è¨‚é–±ç‹€æ…‹è®Šæ›´
    UserStore.subscribe((state) => {
      this.updateExpBar(state.exp);
      this.updateLevelDisplay(state.level);
      this.updateTitle(state.title);
    });
  }
}

// ==================== ç²å–ç‹€æ…‹ ====================

const currentState = UserStore.getState();
console.log(`ç•¶å‰ç­‰ç´šï¼š${currentState.level}`);
console.log(`ç•¶å‰ç¶“é©—å€¼ï¼š${currentState.exp}`);
```

**å„ªå‹¢**ï¼š
1. **å–®ä¸€è³‡æ–™ä¾†æº**ï¼šæ‰€æœ‰ç‹€æ…‹é›†ä¸­ç®¡ç†
2. **å¯è¿½è¹¤**ï¼šæ‰€æœ‰è®Šæ›´éƒ½å¯è¨˜éŒ„
3. **å¯é æ¸¬**ï¼šreducer æ˜¯ç´”å‡½æ•¸
4. **æ˜“æ¸¬è©¦**ï¼šå¯ä»¥å–®ç¨æ¸¬è©¦ reducer
5. **æ™‚å…‰æ—…è¡Œ**ï¼šå¯ä»¥å¯¦ä½œ undo/redo

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `js/core/store.ts`
- `js/actions/user-actions.ts`ï¼ˆAction Creatorsï¼‰
- `js/reducers/user-reducer.ts`ï¼ˆReducer å‡½æ•¸ï¼‰

---

### ğŸ¨ å»ºè­° #27ï¼šCSS é›™å±¤è®Šæ•¸æ¶æ§‹

**ç›®çš„**ï¼šåˆ†é›¢åŸå§‹è‰²ç›¤èˆ‡èªæ„è®Šæ•¸ï¼Œæå‡å¯ç¶­è­·æ€§

```css
/* css/base/tokens.css */

/**
 * ==================== ç¬¬ä¸€å±¤ï¼šåŸå§‹è‰²ç›¤ (Palette) ====================
 *
 * é€™äº›æ˜¯ç´”ç²¹çš„é¡è‰²å®šç¾©ï¼Œä¸å¸¶ä»»ä½•èªæ„
 * å‘½åè¦å‰‡ï¼š--é¡è‰²å-æ•¸å­— (50-900)
 */

:root {
  /* ç«ç‘°è‰²ç³» (Rose) */
  --rose-50: #FFF1F2;
  --rose-100: #FFE4E6;
  --rose-200: #FECDD3;
  --rose-300: #FDA4AF;
  --rose-400: #FB7185;
  --rose-500: #D4A5A5;  /* ä¸»è¦ç«ç‘°è‰² */
  --rose-600: #BE8D8D;
  --rose-700: #9C6D6D;
  --rose-800: #7D5555;
  --rose-900: #5F3F3F;

  /* ç´«è‰²ç³» (Purple) */
  --purple-50: #FAF5FF;
  --purple-100: #F3E8FF;
  --purple-200: #E9D5FF;
  --purple-300: #D8B4FE;
  --purple-400: #C084FC;
  --purple-500: #B8A9C9;  /* ä¸»è¦ç´«è‰² */
  --purple-600: #9D89B0;
  --purple-700: #7F6A8F;
  --purple-800: #64526F;
  --purple-900: #4A3C52;

  /* ä¸­æ€§è‰²ç³» (Gray) */
  --gray-50: #F9FAFB;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-300: #D1D5DB;
  --gray-400: #9CA3AF;
  --gray-500: #6B7280;
  --gray-600: #4B5563;
  --gray-700: #374151;
  --gray-800: #1F2937;
  --gray-900: #111827;

  /* åŠŸèƒ½è‰² */
  --green-500: #10B981;  /* æˆåŠŸ */
  --red-500: #EF4444;    /* éŒ¯èª¤ */
  --yellow-500: #F59E0B; /* è­¦å‘Š */
  --blue-500: #3B82F6;   /* è³‡è¨Š */

  /* è©•åˆ†é¡è‰² */
  --gold-500: #FFD700;   /* å„ªç§€ */
  --lime-500: #84CC16;   /* è‰¯å¥½ */
  --sky-500: #0EA5E9;    /* åŠæ ¼ */
  --orange-500: #F97316; /* éœ€æ”¹é€² */
}

/**
 * ==================== ç¬¬äºŒå±¤ï¼šèªæ„è®Šæ•¸ (Semantic) ====================
 *
 * é€™äº›è®Šæ•¸å°æ‡‰åˆ°å¯¦éš›çš„ä½¿ç”¨å ´æ™¯
 * å‘½åè¦å‰‡ï¼š--ç”¨é€”-è®Šé«”
 */

:root {
  /* ========== å“ç‰Œé¡è‰² ========== */
  --color-primary: var(--rose-500);
  --color-primary-hover: var(--rose-600);
  --color-primary-light: var(--rose-100);

  --color-secondary: var(--purple-500);
  --color-secondary-hover: var(--purple-600);
  --color-secondary-light: var(--purple-100);

  /* ========== èƒŒæ™¯é¡è‰² ========== */
  --color-background: #FFFFFF;
  --color-background-alt: var(--gray-50);
  --color-surface: var(--gray-100);
  --color-surface-hover: var(--gray-200);

  /* ========== æ–‡å­—é¡è‰² ========== */
  --color-text-primary: var(--gray-900);
  --color-text-secondary: var(--gray-600);
  --color-text-tertiary: var(--gray-400);
  --color-text-inverse: #FFFFFF;

  /* ========== ç‹€æ…‹é¡è‰² ========== */
  --color-success: var(--green-500);
  --color-error: var(--red-500);
  --color-warning: var(--yellow-500);
  --color-info: var(--blue-500);

  /* ========== è©•åˆ†é¡è‰² ========== */
  --color-score-excellent: var(--gold-500);
  --color-score-good: var(--lime-500);
  --color-score-pass: var(--sky-500);
  --color-score-need-improve: var(--orange-500);
  --color-score-fail: var(--red-500);

  /* ========== ç­‰ç´šé¡è‰² ========== */
  --color-level-1: var(--gray-400);
  --color-level-2: var(--gray-500);
  --color-level-3: var(--blue-500);
  --color-level-5: var(--purple-500);
  --color-level-8: var(--gold-500);
  --color-level-10: var(--rose-500);

  /* ========== äº’å‹•é¡è‰² ========== */
  --color-border: var(--gray-200);
  --color-border-hover: var(--gray-300);
  --color-focus: var(--rose-500);
  --color-disabled: var(--gray-300);
}

/**
 * ==================== æ·±è‰²æ¨¡å¼ï¼ˆæœªä¾†æ“´å……ï¼‰====================
 */
[data-theme="dark"] {
  /* é‡æ–°å®šç¾©èªæ„è®Šæ•¸å³å¯ï¼Œä¸éœ€æ”¹å‹• Palette */
  --color-background: var(--gray-900);
  --color-background-alt: var(--gray-800);
  --color-surface: var(--gray-700);
  --color-text-primary: var(--gray-50);
  --color-text-secondary: var(--gray-300);

  /* å“ç‰Œè‰²ä¸è®Š */
  --color-primary: var(--rose-400);
  --color-secondary: var(--purple-400);
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```css
/* âŒ ä¸æ¨è–¦ï¼šç›´æ¥ä½¿ç”¨ Palette */
.button {
  background: var(--rose-500);  /* å¦‚æœè¦æ”¹æˆç´«è‰²ï¼Œéœ€è¦å…¨åŸŸæœå°‹æ›¿æ› */
}

/* âœ… æ¨è–¦ï¼šä½¿ç”¨ Semantic */
.button {
  background: var(--color-primary);  /* åªéœ€æ”¹ :root å°±èƒ½å…¨åŸŸåˆ‡æ› */
}

/* âœ… ç‰¹æ®Šæƒ…æ³å¯ä»¥ä½¿ç”¨ Paletteï¼ˆä¾‹å¦‚æ¼¸å±¤ï¼‰ */
.gradient {
  background: linear-gradient(135deg, var(--rose-300), var(--purple-300));
}
```

**å„ªå‹¢**ï¼š
1. **æ˜“ç¶­è­·**ï¼šæ”¹é¡è‰²åªéœ€ä¿®æ”¹ `:root`
2. **æ·±è‰²æ¨¡å¼**ï¼šåªéœ€é‡æ–°å®šç¾©èªæ„è®Šæ•¸
3. **å¯æ“´å……**ï¼šæ–°å¢ä¸»é¡Œä¸å½±éŸ¿å…ƒä»¶
4. **èªæ„æ¸…æ™°**ï¼š`--color-primary` æ¯” `--rose-500` æ›´æ˜“ç†è§£

**å¯¦ä½œæª”æ¡ˆ**ï¼š
- `css/base/tokens.css`ï¼ˆåŸå§‹è‰²ç›¤ + èªæ„è®Šæ•¸ï¼‰
- `css/base/themes.css`ï¼ˆä¸»é¡Œåˆ‡æ›ï¼Œæœªä¾†æ“´å……ï¼‰

---

---

## ğŸ“Š å¯¦ä½œå„ªå…ˆç´šç¸½è¦½

### ç«‹å³å¯¦ä½œï¼ˆP0ï¼‰

é€™äº›æ˜¯æ¶æ§‹çš„æ ¸å¿ƒåŸºç¤ï¼Œå¿…é ˆå„ªå…ˆå¯¦ä½œï¼š

1. **GameConfig** - é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®
2. **ErrorBoundary** - é¿å…ç™½å±ï¼Œæä¾›å‹å–„éŒ¯èª¤
3. **EventBus** - è§£è€¦ Core èˆ‡ UI
4. **Store Pattern** - çµ±ä¸€ç‹€æ…‹ç®¡ç†
5. **Calculator ID** - å®‰å…¨çš„è©•åˆ†ç³»çµ±
6. **Zod Validation** - å‹åˆ¥å®‰å…¨
7. **State Normalization** - åˆ†é›¢æŒä¹…åŒ–èˆ‡è¨ˆç®—æ•¸æ“š

### æ¬¡è¦å¯¦ä½œï¼ˆP1ï¼‰

é€™äº›æå‡é–‹ç™¼é«”é©—å’Œä½¿ç”¨è€…é«”é©—ï¼š

8. **ResourceLoader** - è¼‰å…¥é€²åº¦èˆ‡é è¼‰å…¥
9. **JSDoc** - å®Œæ•´çš„å‹åˆ¥è¨»é‡‹
10. **Dynamic Import** - å»¶é²è¼‰å…¥æ¨¡çµ„
11. **CSS é›™å±¤è®Šæ•¸** - Palette + Semantic
12. **FSM** - éšæ®µæµè½‰ç®¡ç†
13. **Scoring Service** - æ¨¡çµ„åŒ–è©•åˆ†
14. **Storage Migration** - ç‰ˆæœ¬é·ç§»

### å»ºè­°å¯¦ä½œï¼ˆP2-P3ï¼‰

é€™äº›æå‡æ²‰æµ¸æ„Ÿå’Œç´°ç¯€ï¼š

15. **è½‰å ´å‹•ç•«** - 5 ç¨®å…¨è¢å¹•è½‰å ´
16. **å‹•æ…‹å„€è¡¨æ¿** - æ•¸å­—è·³å‹•ã€ç…™ç«ç‰¹æ•ˆ
17. **äº’å‹•åœ°åœ–** - æ‡¸åœé è¦½
18. **å°è©±ç³»çµ±** - emotion + typewriter
19. **è³‡ç”¢ç®¡ç†** - Emoji â‡„ åœ–ç‰‡åˆ‡æ›
20. **æˆå°±ç³»çµ±** - æ…¶ç¥å‹•ç•«

---

## ğŸ“š å·²å®Œæˆæ–‡ä»¶æ¸…å–®

| æ–‡ä»¶ | å…§å®¹ | è¡Œæ•¸ | ç‹€æ…‹ |
|------|------|------|------|
| [README.md](../README.md) | å°ˆæ¡ˆèªªæ˜ | 280 è¡Œ | âœ… å®Œæˆ |
| [STRUCTURE.md](../STRUCTURE.md) | æ¶æ§‹èªªæ˜ | 694 è¡Œ | âœ… å®Œæˆ |
| [DATA-STRUCTURE.md](../DATA-STRUCTURE.md) | è³‡æ–™çµæ§‹ | 685 è¡Œ | âœ… å®Œæˆ |
| [FRONTEND-LOGIC.md](./FRONTEND-LOGIC.md) | å‰ç«¯é‚è¼¯ | 605 è¡Œ | âœ… å®Œæˆ |
| [TECHNICAL-OPTIMIZATION.md](./TECHNICAL-OPTIMIZATION.md) | æŠ€è¡“å„ªåŒ– | 850 è¡Œ | âœ… å®Œæˆ |
| **IMPLEMENTATION-GUIDE.md** | **æœ¬æ–‡ä»¶** | **3300+ è¡Œ** | âœ… å®Œæˆ |

**ç¸½è¨ˆ**ï¼š6 ä»½å®Œæ•´æ–‡ä»¶ï¼Œè¶…é 7,000 è¡Œè©³ç´°è¦ç¯„

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### éšæ®µ 1ï¼šæ ¸å¿ƒæ¶æ§‹ï¼ˆ1-2 é€±ï¼‰

1. å»ºç«‹ `js/config/game-config.js`
2. å»ºç«‹ `js/core/error-boundary.ts`
3. å»ºç«‹ `js/core/event-bus.ts`
4. å»ºç«‹ `js/core/store.ts`
5. é‡æ§‹ç¾æœ‰ç‹€æ…‹ç®¡ç†ä½¿ç”¨ Store Pattern

### éšæ®µ 2ï¼šè³‡æ–™èˆ‡å®‰å…¨ï¼ˆ1 é€±ï¼‰

6. å¯¦ä½œ Calculator ID ç³»çµ±
7. æ•´åˆ Zod é©—è­‰
8. å¯¦ä½œ StorageManager ç‰ˆæœ¬é·ç§»
9. å»ºç«‹æ‰€æœ‰ TypeScript å‹åˆ¥å®šç¾©

### éšæ®µ 3ï¼šè¼‰å…¥èˆ‡æ•ˆèƒ½ï¼ˆ1 é€±ï¼‰

10. å¯¦ä½œ ResourceLoader
11. åŠ å…¥å‹•æ…‹ import
12. å„ªåŒ–é¦–å±è¼‰å…¥é€Ÿåº¦

### éšæ®µ 4ï¼šUI/UX å¢å¼·ï¼ˆ2-3 é€±ï¼‰

13. å¯¦ä½œ FSM éšæ®µç®¡ç†
14. åŠ å…¥è½‰å ´å‹•ç•«
15. å¯¦ä½œå°è©±ç³»çµ±
16. æˆå°±èˆ‡æ…¶ç¥ç‰¹æ•ˆ

### éšæ®µ 5ï¼šæ¸¬è©¦èˆ‡éƒ¨ç½²ï¼ˆ1 é€±ï¼‰

17. å®Œæ•´æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½
18. ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦
19. æ•ˆèƒ½æ¸¬è©¦èˆ‡å„ªåŒ–
20. æ­£å¼éƒ¨ç½²åˆ° lab.helloruru.com

---

## ğŸ’¡ é–‹ç™¼å»ºè­°

### ä½¿ç”¨ TypeScript

é›–ç„¶å°ˆæ¡ˆä½¿ç”¨ JSï¼Œä½†å»ºè­°ä½¿ç”¨ `.ts` æª”æ¡ˆä¸¦é€éç·¨è­¯ï¼š

```bash
# å®‰è£ TypeScript
npm install -D typescript

# ç·¨è­¯ç‚º JS
tsc --outDir dist --target ES2020 --module ES2020
```

### ä½¿ç”¨ Linter

```bash
# ESLint
npm install -D eslint

# é…ç½®
{
  "extends": ["eslint:recommended"],
  "parserOptions": {
    "ecmaVersion": 2020,
    "sourceType": "module"
  }
}
```

### Git Commit è¦ç¯„

```bash
# æ ¼å¼
<type>(<scope>): <subject>

# ç¯„ä¾‹
feat(core): add EventBus implementation
fix(scoring): correct keyword density calculation
docs(guide): add JSDoc examples
style(css): update color tokens
```

---

## ğŸ“ è¯çµ¡èˆ‡æ”¯æ´

- **ä½œè€…**ï¼šKaoru Tsai (Hello Ruru)
- **Email**ï¼šhello@helloruru.com
- **å°ˆæ¡ˆç¶²å€**ï¼šhttps://lab.helloruru.com/seo-quest/
- **æ›´æ–°æ—¥æœŸ**ï¼š2026-02-12
- **ç‰ˆæœ¬**ï¼š1.0.0 (åŸºç¤æ¶æ§‹ + é–‹ç™¼è€…é«”é©—å¼·åŒ–)

---

**ğŸ‰ æ­å–œï¼å®Œæ•´çš„å¯¦ä½œæŒ‡å—å·²ç¶“æº–å‚™å¥½äº†ï¼**

ç¾åœ¨å¯ä»¥é–‹å§‹ä¾ç…§å„ªå…ˆç´šé€æ­¥å¯¦ä½œï¼Œæ‰“é€ å‡ºå°ˆæ¥­ã€å®‰å…¨ã€å¯ç¶­è­·çš„ SEO Quest ç³»çµ±ï¼

**æ–‡ä»¶ä½œè€…**ï¼šClaude Sonnet 4.5 + å°ç«ç‘° (Microsoft Laptop 10 Rose Gold)
**æŒ‡å°é¡§å•**ï¼šåš•åš•ä¸»äºº (Ruru) + Gemini (æ¶æ§‹å»ºè­°)
**æœ€å¾Œæ›´æ–°**ï¼š2026-02-12 02:00 AM
