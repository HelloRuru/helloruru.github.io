<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGE æ–‡æ¡ˆåŠ©æ‰‹ - è§’è‰²ç«‹ç¹ªä¸Šå‚³</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --rose: #D4A5A5;
      --lavender: #B8A9C9;
      --sage: #A8B5A0;
      --text: #333333;
      --text-light: #888888;
      --bg: #FAFAFA;
      --card-bg: #FFFFFF;
      --border: #E8E4E1;
      --success: #A8B5A0;
      --warning: #E8B4B8;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--rose), var(--lavender));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: var(--text-light);
      margin-bottom: 32px;
    }

    /* Spec Card */
    .spec-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .spec-card h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .spec-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .spec-item {
      background: var(--bg);
      padding: 12px 16px;
      border-radius: 12px;
    }

    .spec-item label {
      font-size: 12px;
      color: var(--text-light);
      display: block;
      margin-bottom: 4px;
    }

    .spec-item strong {
      font-size: 16px;
      color: var(--text);
    }

    /* Character Reference */
    .character-ref {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .character-ref h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .ref-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .ref-grid { grid-template-columns: 1fr; }
    }

    .ref-card {
      padding: 16px;
      border-radius: 16px;
      text-align: center;
    }

    .ref-card.guide { background: rgba(212, 165, 165, 0.15); }
    .ref-card.writer { background: rgba(184, 169, 201, 0.15); }
    .ref-card.player { background: rgba(168, 181, 160, 0.15); }

    .ref-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .ref-card.guide .ref-avatar { background: var(--rose); }
    .ref-card.writer .ref-avatar { background: var(--lavender); }
    .ref-card.player .ref-avatar { background: var(--sage); }

    .ref-name {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .ref-desc {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .ref-files {
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,0.6);
      padding: 8px;
      border-radius: 8px;
      font-family: monospace;
    }

    /* Progress */
    .progress-bar {
      background: var(--bg);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 24px 0 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--rose), var(--lavender));
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .progress-text {
      text-align: center;
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 24px;
    }

    /* Emotion Section */
    .emotion-section {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .emotion-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .emotion-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: var(--bg);
    }

    .emotion-info h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .emotion-info p {
      font-size: 14px;
      color: var(--text-light);
    }

    .emotion-count {
      margin-left: auto;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .emotion-count.complete {
      background: rgba(168, 181, 160, 0.2);
      color: var(--sage);
    }

    .emotion-count.pending {
      background: var(--bg);
      color: var(--text-light);
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      margin-bottom: 16px;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--rose);
      background: rgba(212, 165, 165, 0.05);
    }

    .drop-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .drop-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .drop-text {
      font-size: 14px;
      color: var(--text-light);
    }

    .drop-text strong {
      color: var(--rose);
    }

    /* Preview Grid */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .preview-slot {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      position: relative;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .preview-slot.filled {
      background: rgba(168, 181, 160, 0.1);
    }

    .preview-slot.guide { border-left: 3px solid var(--rose); }
    .preview-slot.writer { border-left: 3px solid var(--lavender); }
    .preview-slot.player { border-left: 3px solid var(--sage); }

    .preview-img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 8px;
      background: white;
      margin-bottom: 8px;
    }

    .preview-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
    }

    .preview-filename {
      font-size: 10px;
      color: var(--text-light);
      font-family: monospace;
      margin-top: 4px;
    }

    .preview-empty {
      color: var(--text-light);
      font-size: 24px;
    }

    .preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .preview-slot.filled:hover .preview-remove {
      display: flex;
    }

    /* Actions */
    .actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--rose), var(--lavender));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(212, 165, 165, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    /* Output */
    .output-section {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-top: 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: none;
    }

    .output-section.show { display: block; }

    .output-section h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .output-list {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 16px;
      border-radius: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      overflow-x: auto;
    }

    .output-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }

    .output-item:last-child { border-bottom: none; }

    .output-status { width: 20px; text-align: center; }
    .output-filename { flex: 1; color: #a6e22e; }
    .output-size { color: #888; }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      color: var(--text-light);
      font-size: 14px;
    }

    footer a {
      color: var(--rose);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SGE æ–‡æ¡ˆåŠ©æ‰‹ â€” è§’è‰²ç«‹ç¹ªä¸Šå‚³</h1>
    <p class="subtitle">ä¾è¡¨æƒ…åˆ†é¡æ‰¹é‡ä¸Šå‚³ï¼Œæ¯å€å¯ä¸€æ¬¡æ‹–æ”¾è©²è¡¨æƒ…çš„ 3 å¼µè§’è‰²åœ–</p>

    <!-- è¦æ ¼èªªæ˜ -->
    <div class="spec-card">
      <h2>ğŸ“‹ æª”æ¡ˆè¦æ ¼</h2>
      <div class="spec-grid">
        <div class="spec-item">
          <label>å°ºå¯¸</label>
          <strong>512 Ã— 512 px</strong>
        </div>
        <div class="spec-item">
          <label>æ ¼å¼</label>
          <strong>PNGï¼ˆé€æ˜èƒŒæ™¯ï¼‰</strong>
        </div>
        <div class="spec-item">
          <label>é¢¨æ ¼</label>
          <strong>Qç‰ˆå¯æ„› / æ—¥ç³» RPG</strong>
        </div>
        <div class="spec-item">
          <label>ç¸½æ•¸é‡</label>
          <strong>12 å¼µï¼ˆ3è§’è‰² Ã— 4è¡¨æƒ…ï¼‰</strong>
        </div>
      </div>
    </div>

    <!-- è§’è‰²å°ç…§è¡¨ -->
    <div class="character-ref">
      <h2>ğŸ­ è§’è‰²å°ç…§è¡¨ï¼ˆæª”åè¦å‰‡ï¼‰</h2>
      <div class="ref-grid">
        <div class="ref-card guide">
          <div class="ref-avatar">C</div>
          <div class="ref-name">æ–‡æ¡ˆå°C</div>
          <div class="ref-desc">å§Šå§Šç³» Â· åœ“æ¡†çœ¼é¡ Â· ä¸­é•·é«®</div>
          <div class="ref-files">guide-*.png</div>
        </div>
        <div class="ref-card writer">
          <div class="ref-avatar">H</div>
          <div class="ref-name">å“ˆçš®</div>
          <div class="ref-desc">å…ƒæ°£å°‘å¥³ Â· éŸ³ç¬¦é«®å¤¾ Â· é•·æ²é«®</div>
          <div class="ref-files">writer-*.png</div>
        </div>
        <div class="ref-card player">
          <div class="ref-avatar">L</div>
          <div class="ref-name">éœ²éœ²</div>
          <div class="ref-desc">å°è˜¿è‰ Â· é›™é¦¬å°¾ Â· å°èƒŒåŒ…</div>
          <div class="ref-files">player-*.png</div>
        </div>
      </div>
    </div>

    <!-- é€²åº¦æ¢ -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <p class="progress-text" id="progressText">å·²ä¸Šå‚³ 0 / 12 å¼µ</p>

    <!-- æ¨‚ Joy -->
    <div class="emotion-section" data-emotion="joy">
      <div class="emotion-header">
        <div class="emotion-icon">ğŸ˜Š</div>
        <div class="emotion-info">
          <h3>æ¨‚ Joy â€” ä¸€èˆ¬å¼•å° / é–‹å§‹æ’°å¯«</h3>
          <p>æ­¡è¿ä½¿ç”¨è€…ã€æ—¥å¸¸å°è©±ã€æº–å‚™é–‹å§‹</p>
        </div>
        <div class="emotion-count pending" id="joy-count">0 / 3</div>
      </div>
      <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'joy')">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">æ‹–æ”¾ 3 å¼µã€Œæ¨‚ã€è¡¨æƒ…çš„åœ–ç‰‡åˆ°é€™è£¡<br>æˆ– <strong>é»æ“Šé¸æ“‡æª”æ¡ˆ</strong></div>
        <input type="file" accept="image/png" multiple onchange="handleFiles(this.files, 'joy')">
      </div>
      <div class="preview-grid">
        <div class="preview-slot guide" data-role="guide" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-label">æ–‡æ¡ˆå°C</div>
          <div class="preview-filename">guide-joy.png</div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-label">å“ˆçš®</div>
          <div class="preview-filename">writer-joy.png</div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-label">éœ²éœ²</div>
          <div class="preview-filename">player-joy.png</div>
        </div>
      </div>
    </div>

    <!-- å–œ Happy -->
    <div class="emotion-section" data-emotion="happy">
      <div class="emotion-header">
        <div class="emotion-icon">ğŸ‰</div>
        <div class="emotion-info">
          <h3>å–œ Happy â€” æŸ¥æ ¸é€šé / æ–‡æ¡ˆå®Œæˆ</h3>
          <p>æˆåŠŸå®Œæˆã€ç²å¾—é«˜åˆ†ã€å‡ç´š</p>
        </div>
        <div class="emotion-count pending" id="happy-count">0 / 3</div>
      </div>
      <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'happy')">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">æ‹–æ”¾ 3 å¼µã€Œå–œã€è¡¨æƒ…çš„åœ–ç‰‡åˆ°é€™è£¡<br>æˆ– <strong>é»æ“Šé¸æ“‡æª”æ¡ˆ</strong></div>
        <input type="file" accept="image/png" multiple onchange="handleFiles(this.files, 'happy')">
      </div>
      <div class="preview-grid">
        <div class="preview-slot guide" data-role="guide" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-label">æ–‡æ¡ˆå°C</div>
          <div class="preview-filename">guide-happy.png</div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-label">å“ˆçš®</div>
          <div class="preview-filename">writer-happy.png</div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-label">éœ²éœ²</div>
          <div class="preview-filename">player-happy.png</div>
        </div>
      </div>
    </div>

    <!-- æ€’ Angry -->
    <div class="emotion-section" data-emotion="angry">
      <div class="emotion-header">
        <div class="emotion-icon">ğŸ˜¤</div>
        <div class="emotion-info">
          <h3>æ€’ Angry â€” ç™¼ç¾å•é¡Œ / é•è¦è©è­¦å‘Š</h3>
          <p>æ ¼å¼éŒ¯èª¤ã€é•è¦è©ã€é‡åˆ°å•é¡Œ</p>
        </div>
        <div class="emotion-count pending" id="angry-count">0 / 3</div>
      </div>
      <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'angry')">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">æ‹–æ”¾ 3 å¼µã€Œæ€’ã€è¡¨æƒ…çš„åœ–ç‰‡åˆ°é€™è£¡<br>æˆ– <strong>é»æ“Šé¸æ“‡æª”æ¡ˆ</strong></div>
        <input type="file" accept="image/png" multiple onchange="handleFiles(this.files, 'angry')">
      </div>
      <div class="preview-grid">
        <div class="preview-slot guide" data-role="guide" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-label">æ–‡æ¡ˆå°C</div>
          <div class="preview-filename">guide-angry.png</div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-label">å“ˆçš®</div>
          <div class="preview-filename">writer-angry.png</div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-label">éœ²éœ²</div>
          <div class="preview-filename">player-angry.png</div>
        </div>
      </div>
    </div>

    <!-- å“€ Sad -->
    <div class="emotion-section" data-emotion="sad">
      <div class="emotion-header">
        <div class="emotion-icon">ğŸ˜¢</div>
        <div class="emotion-info">
          <h3>å“€ Sad â€” è³‡æ–™ä¸è¶³ / éœ€è¦é‡å¯«</h3>
          <p>ç¼ºå°‘è³‡è¨Šã€åˆ†æ•¸å¤ªä½ã€ä»»å‹™å¤±æ•—</p>
        </div>
        <div class="emotion-count pending" id="sad-count">0 / 3</div>
      </div>
      <div class="drop-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'sad')">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">æ‹–æ”¾ 3 å¼µã€Œå“€ã€è¡¨æƒ…çš„åœ–ç‰‡åˆ°é€™è£¡<br>æˆ– <strong>é»æ“Šé¸æ“‡æª”æ¡ˆ</strong></div>
        <input type="file" accept="image/png" multiple onchange="handleFiles(this.files, 'sad')">
      </div>
      <div class="preview-grid">
        <div class="preview-slot guide" data-role="guide" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-label">æ–‡æ¡ˆå°C</div>
          <div class="preview-filename">guide-sad.png</div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-label">å“ˆçš®</div>
          <div class="preview-filename">writer-sad.png</div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-label">éœ²éœ²</div>
          <div class="preview-filename">player-sad.png</div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="actions">
      <button class="btn btn-secondary" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨</button>
      <button class="btn btn-primary" id="downloadBtn" onclick="downloadAll()" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        ä¸‹è¼‰ ZIP å£“ç¸®æª”
      </button>
    </div>

    <!-- è¼¸å‡ºå€åŸŸ -->
    <div class="output-section" id="outputSection">
      <h2>ğŸ“¦ å·²ä¸Šå‚³æª”æ¡ˆæ¸…å–®</h2>
      <div class="output-list" id="outputList"></div>
    </div>

    <footer>
      <p>Â© 2026 Kaoru Tsai. All Rights Reserved. | Contact: <a href="mailto:hello@helloruru.com">hello@helloruru.com</a></p>
      <p style="margin-top: 8px;">
        <a href="../../docs/character-design.md" target="_blank">æŸ¥çœ‹å®Œæ•´è§’è‰²è¨­è¨ˆéœ€æ±‚æ–‡ä»¶</a>
      </p>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // å„²å­˜ä¸Šå‚³çš„æª”æ¡ˆ
    const uploadedFiles = new Map();
    const roles = ['guide', 'writer', 'player'];
    const emotions = ['joy', 'happy', 'angry', 'sad'];

    // æ ¹æ“šæª”åçŒœæ¸¬è§’è‰²
    function guessRole(filename) {
      const lower = filename.toLowerCase();
      if (lower.includes('guide') || lower.includes('å°c') || lower.includes('c-') || lower.includes('navigator')) return 'guide';
      if (lower.includes('writer') || lower.includes('å“ˆçš®') || lower.includes('h-') || lower.includes('happy') || lower.includes('bard')) return 'writer';
      if (lower.includes('player') || lower.includes('éœ²éœ²') || lower.includes('l-') || lower.includes('lulu') || lower.includes('apprentice')) return 'player';
      return null;
    }

    // è™•ç†æ‹–æ”¾
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e, emotion) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      handleFiles(e.dataTransfer.files, emotion);
    }

    // è™•ç†æª”æ¡ˆä¸Šå‚³
    function handleFiles(files, emotion) {
      const fileArray = Array.from(files).filter(f => f.type === 'image/png');

      if (fileArray.length === 0) {
        alert('è«‹ä¸Šå‚³ PNG æ ¼å¼çš„åœ–ç‰‡');
        return;
      }

      // æ‰¾å‡ºé€™å€‹è¡¨æƒ…é‚„ç¼ºå“ªäº›è§’è‰²
      const emptySlots = roles.filter(role => !uploadedFiles.has(`${role}-${emotion}.png`));

      fileArray.forEach((file, index) => {
        // å…ˆå˜—è©¦å¾æª”åçŒœæ¸¬è§’è‰²
        let role = guessRole(file.name);

        // å¦‚æœçŒœä¸å‡ºä¾†æˆ–è©²ä½ç½®å·²æœ‰æª”æ¡ˆï¼Œå°±å¡«å…¥ä¸‹ä¸€å€‹ç©ºä½
        if (!role || uploadedFiles.has(`${role}-${emotion}.png`)) {
          role = emptySlots[index] || null;
        }

        if (role) {
          const targetFilename = `${role}-${emotion}.png`;
          uploadedFiles.set(targetFilename, file);
          updateSlot(role, emotion, file);

          // å¾ç©ºä½åˆ—è¡¨ä¸­ç§»é™¤
          const idx = emptySlots.indexOf(role);
          if (idx > -1) emptySlots.splice(idx, 1);
        }
      });

      updateProgress();
    }

    // æ›´æ–°å–®ä¸€æ ¼å­çš„é è¦½
    function updateSlot(role, emotion, file) {
      const slot = document.querySelector(`.preview-slot[data-role="${role}"][data-emotion="${emotion}"]`);
      if (!slot) return;

      slot.classList.add('filled');

      // æ¸…é™¤èˆŠå…§å®¹
      const oldImg = slot.querySelector('.preview-img');
      const oldEmpty = slot.querySelector('.preview-empty');
      if (oldImg) oldImg.remove();
      if (oldEmpty) oldEmpty.remove();

      // æ–°å¢é è¦½åœ–
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.className = 'preview-img';
        img.src = e.target.result;
        slot.insertBefore(img, slot.firstChild);
      };
      reader.readAsDataURL(file);

      // æ–°å¢åˆªé™¤æŒ‰éˆ•
      let removeBtn = slot.querySelector('.preview-remove');
      if (!removeBtn) {
        removeBtn = document.createElement('button');
        removeBtn.className = 'preview-remove';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = () => removeFile(role, emotion);
        slot.appendChild(removeBtn);
      }
    }

    // ç§»é™¤å–®ä¸€æª”æ¡ˆ
    function removeFile(role, emotion) {
      const filename = `${role}-${emotion}.png`;
      uploadedFiles.delete(filename);

      const slot = document.querySelector(`.preview-slot[data-role="${role}"][data-emotion="${emotion}"]`);
      slot.classList.remove('filled');

      const img = slot.querySelector('.preview-img');
      if (img) img.remove();

      const removeBtn = slot.querySelector('.preview-remove');
      if (removeBtn) removeBtn.remove();

      // é‡æ–°åŠ å…¥ç©ºç™½ç¬¦è™Ÿ
      const empty = document.createElement('div');
      empty.className = 'preview-empty';
      empty.textContent = '+';
      slot.insertBefore(empty, slot.firstChild);

      updateProgress();
    }

    // æ›´æ–°é€²åº¦
    function updateProgress() {
      const total = 12;
      const count = uploadedFiles.size;
      const percent = (count / total) * 100;

      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = `å·²ä¸Šå‚³ ${count} / ${total} å¼µ`;

      // æ›´æ–°æ¯å€‹è¡¨æƒ…å€çš„è¨ˆæ•¸
      emotions.forEach(emotion => {
        const emotionCount = roles.filter(role => uploadedFiles.has(`${role}-${emotion}.png`)).length;
        const countEl = document.getElementById(`${emotion}-count`);
        countEl.textContent = `${emotionCount} / 3`;
        countEl.className = emotionCount === 3 ? 'emotion-count complete' : 'emotion-count pending';
      });

      // å•Ÿç”¨/ç¦ç”¨ä¸‹è¼‰æŒ‰éˆ•
      document.getElementById('downloadBtn').disabled = count === 0;

      // æ›´æ–°è¼¸å‡ºå€åŸŸ
      updateOutput();
    }

    function updateOutput() {
      const outputSection = document.getElementById('outputSection');
      const outputList = document.getElementById('outputList');

      if (uploadedFiles.size === 0) {
        outputSection.classList.remove('show');
        return;
      }

      outputSection.classList.add('show');

      let html = '';
      const sortedFiles = Array.from(uploadedFiles.entries()).sort((a, b) => a[0].localeCompare(b[0]));

      sortedFiles.forEach(([filename, file]) => {
        const sizeKB = (file.size / 1024).toFixed(1);
        html += `
          <div class="output-item">
            <span class="output-status">âœ“</span>
            <span class="output-filename">${filename}</span>
            <span class="output-size">${sizeKB} KB</span>
          </div>
        `;
      });

      outputList.innerHTML = html;
    }

    function clearAll() {
      if (uploadedFiles.size === 0) return;
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡å—ï¼Ÿ')) return;

      uploadedFiles.clear();

      // é‡ç½®æ‰€æœ‰æ ¼å­
      document.querySelectorAll('.preview-slot').forEach(slot => {
        slot.classList.remove('filled');

        const img = slot.querySelector('.preview-img');
        if (img) img.remove();

        const removeBtn = slot.querySelector('.preview-remove');
        if (removeBtn) removeBtn.remove();

        let empty = slot.querySelector('.preview-empty');
        if (!empty) {
          empty = document.createElement('div');
          empty.className = 'preview-empty';
          empty.textContent = '+';
          slot.insertBefore(empty, slot.firstChild);
        }
      });

      // é‡ç½® input
      document.querySelectorAll('.drop-zone input').forEach(input => input.value = '');

      updateProgress();
    }

    async function downloadAll() {
      if (uploadedFiles.size === 0) {
        alert('è«‹å…ˆä¸Šå‚³è‡³å°‘ä¸€å¼µåœ–ç‰‡');
        return;
      }

      const btn = document.getElementById('downloadBtn');
      btn.disabled = true;
      btn.innerHTML = 'â³ æ­£åœ¨æ‰“åŒ…...';

      try {
        const zip = new JSZip();

        for (const [filename, file] of uploadedFiles) {
          const arrayBuffer = await file.arrayBuffer();
          zip.file(filename, arrayBuffer);
        }

        const blob = await zip.generateAsync({ type: 'blob' });

        // ä¸‹è¼‰
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'sge-writer-characters.zip';
        link.click();

        URL.revokeObjectURL(link.href);

        btn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          ä¸‹è¼‰ ZIP å£“ç¸®æª”
        `;
        btn.disabled = false;

      } catch (err) {
        console.error(err);
        alert('æ‰“åŒ…å¤±æ•—ï¼š' + err.message);
        btn.innerHTML = 'ä¸‹è¼‰ ZIP å£“ç¸®æª”';
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
