<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGE æ–‡æ¡ˆåŠ©æ‰‹ - è§’è‰²ç«‹ç¹ªä¸Šå‚³</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --rose: #D4A5A5;
      --lavender: #B8A9C9;
      --sage: #A8B5A0;
      --text: #333333;
      --text-light: #888888;
      --bg: #FAFAFA;
      --card-bg: #FFFFFF;
      --border: #E8E4E1;
      --success: #A8B5A0;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--rose), var(--lavender));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: var(--text-light);
      margin-bottom: 32px;
    }

    .color-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }

    .color-dot.rose { background: var(--rose); }
    .color-dot.lavender { background: var(--lavender); }
    .color-dot.sage { background: var(--sage); }

    /* ä½¿ç”¨èªªæ˜ */
    .instruction-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .instruction-card h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 20px;
    }

    .steps {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 600px) {
      .steps { grid-template-columns: 1fr; }
    }

    .step {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg);
      border-radius: 12px;
    }

    .step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--rose), var(--lavender));
      color: white;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .step-content strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .step-content p {
      font-size: 13px;
      color: var(--text-light);
      margin: 0;
    }

    /* è§’è‰²å°ç…§ */
    .character-ref {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 20px 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .character-ref h2 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .ref-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .ref-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .ref-item strong {
      font-weight: 500;
    }

    .ref-desc {
      color: var(--text-light);
      font-size: 13px;
    }

    /* å¤§ä¸Šå‚³å€ */
    .upload-zone {
      background: var(--card-bg);
      border: 3px dashed var(--border);
      border-radius: 24px;
      padding: 60px 40px;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--rose);
      background: rgba(212, 165, 165, 0.05);
    }

    .upload-zone input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .upload-title {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .upload-desc {
      color: var(--text-light);
      font-size: 14px;
    }

    .upload-desc strong {
      color: var(--rose);
    }

    /* é€²åº¦ */
    .progress-section {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .progress-header h2 {
      font-size: 18px;
      font-weight: 500;
    }

    .progress-count {
      font-size: 14px;
      color: var(--text-light);
    }

    .progress-bar {
      background: var(--bg);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--rose), var(--lavender));
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* é è¦½æ ¼å­ */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .preview-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .preview-slot {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      position: relative;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .preview-slot.filled {
      background: rgba(168, 181, 160, 0.1);
      border-color: var(--success);
    }

    .preview-slot.guide { border-left: 4px solid var(--rose); }
    .preview-slot.writer { border-left: 4px solid var(--lavender); }
    .preview-slot.player { border-left: 4px solid var(--sage); }

    .preview-img {
      width: 80%;
      height: 60%;
      object-fit: contain;
      border-radius: 8px;
      background: white;
    }

    .preview-info {
      margin-top: 8px;
    }

    .preview-role {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
    }

    .preview-emotion {
      font-size: 11px;
      color: var(--text-light);
    }

    .preview-filename {
      font-size: 9px;
      color: var(--text-light);
      font-family: monospace;
      margin-top: 2px;
    }

    .preview-empty {
      color: var(--border);
      font-size: 32px;
    }

    .preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .preview-slot.filled:hover .preview-remove {
      display: flex;
    }

    /* æ“ä½œæŒ‰éˆ• */
    .actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--rose), var(--lavender));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(212, 165, 165, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    /* é¡å¤–åœ–ç‰‡å€ */
    .extra-section {
      border: 2px dashed var(--lavender);
      background: rgba(184, 169, 201, 0.05);
    }

    .extra-drop {
      padding: 30px;
      margin-bottom: 16px;
    }

    .extra-grid {
      grid-template-columns: repeat(5, 1fr);
    }

    @media (max-width: 768px) {
      .extra-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* å‚™è¨»æ¬„ */
    .notes-section {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .notes-section h2 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .notes-section textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      background: var(--bg);
    }

    .notes-section textarea:focus {
      outline: none;
      border-color: var(--rose);
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      color: var(--text-light);
      font-size: 14px;
    }

    footer a {
      color: var(--rose);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SGE æ–‡æ¡ˆåŠ©æ‰‹ â€” è§’è‰²ç«‹ç¹ªä¸Šå‚³</h1>
    <p class="subtitle">ä¸€æ¬¡ä¸Ÿå…¥å…¨éƒ¨ 12 å¼µ PNGï¼Œç³»çµ±è‡ªå‹•æ ¹æ“šæª”ååˆ†é¡</p>

    <!-- ä½¿ç”¨èªªæ˜ -->
    <div class="instruction-card">
      <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
      <div class="steps">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-content">
            <strong>æª”åéš¨ä¾¿å–æ²’é—œä¿‚</strong>
            <p>ç›´æ¥æŠŠ 12 å¼µ PNG å…¨éƒ¨ä¸Ÿé€²ä¾†ï¼Œä¸ç”¨ç‰¹åˆ¥æ”¹æª”å</p>
          </div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-content">
            <strong>æª¢æŸ¥ä¸‹æ–¹é è¦½æ ¼å­</strong>
            <p>ç³»çµ±æœƒéš¨æ©Ÿå¡«å…¥ç©ºä½ï¼Œä½ åªéœ€ç¢ºèªæ¯å¼µåœ–åœ¨æ­£ç¢ºçš„ä½ç½®</p>
          </div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-content">
            <strong>ä½ç½®éŒ¯äº†ï¼Ÿé» Ã— åˆªé™¤é‡å‚³</strong>
            <p>æŠŠéŒ¯çš„åˆªæ‰ï¼Œå†å–®ç¨ä¸Šå‚³åˆ°æ­£ç¢ºæ ¼å­å³å¯</p>
          </div>
        </div>
        <div class="step">
          <div class="step-num">4</div>
          <div class="step-content">
            <strong>ç¢ºèªå¾Œä¸‹è¼‰ ZIP</strong>
            <p>ZIP å…§çš„æª”åæœƒè‡ªå‹•æ”¹æˆæ­£ç¢ºæ ¼å¼ï¼Œç›´æ¥çµ¦æˆ‘å°±å¥½</p>
          </div>
        </div>
      </div>
    </div>

    <!-- è§’è‰²å°ç…§ -->
    <div class="character-ref">
      <h2>ğŸ­ è§’è‰²è¾¨è­˜ï¼ˆä¾›åƒè€ƒï¼Œä¸å¼·åˆ¶ï¼‰</h2>
      <div class="ref-row">
        <div class="ref-item">
          <span class="color-dot rose"></span>
          <strong>ä¼Šæ­</strong>
          <span class="ref-desc">å§Šå§Šç³»ãƒ»åœ“æ¡†çœ¼é¡</span>
        </div>
        <div class="ref-item">
          <span class="color-dot lavender"></span>
          <strong>å“ˆçš®</strong>
          <span class="ref-desc">å…ƒæ°£å°‘å¥³ãƒ»éŸ³ç¬¦é«®å¤¾</span>
        </div>
        <div class="ref-item">
          <span class="color-dot sage"></span>
          <strong>BLUE</strong>
          <span class="ref-desc">å°è˜¿è‰ãƒ»é›™é¦¬å°¾</span>
        </div>
      </div>
    </div>

    <!-- å¤§ä¸Šå‚³å€ -->
    <div class="upload-zone" id="uploadZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-title">æŠŠ 12 å¼µ PNG å…¨éƒ¨ä¸Ÿé€²ä¾†</div>
      <div class="upload-desc">æ‹–æ”¾æª”æ¡ˆæˆ– <strong>é»æ“Šé¸æ“‡</strong>ï¼ˆ512Ã—512 é€æ˜èƒŒæ™¯ PNGï¼‰</div>
      <input type="file" accept="image/png" multiple onchange="handleFiles(this.files)">
    </div>

    <!-- é€²åº¦èˆ‡é è¦½ -->
    <div class="progress-section">
      <div class="progress-header">
        <h2>ğŸ“¦ ä¸Šå‚³é€²åº¦</h2>
        <span class="progress-count" id="progressCount">0 / 12 å¼µ</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>

      <div class="preview-grid" id="previewGrid">
        <!-- æ¨‚ Joy -->
        <div class="preview-slot guide" data-role="guide" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">ä¼Šæ­</div>
            <div class="preview-emotion">æ¨‚ Joy</div>
          </div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å“ˆçš®</div>
            <div class="preview-emotion">æ¨‚ Joy</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="joy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">BLUE</div>
            <div class="preview-emotion">æ¨‚ Joy</div>
          </div>
        </div>

        <!-- å–œ Happy -->
        <div class="preview-slot guide" data-role="guide" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">ä¼Šæ­</div>
            <div class="preview-emotion">å–œ Happy</div>
          </div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å“ˆçš®</div>
            <div class="preview-emotion">å–œ Happy</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="happy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">BLUE</div>
            <div class="preview-emotion">å–œ Happy</div>
          </div>
        </div>

        <!-- æ€’ Angry -->
        <div class="preview-slot guide" data-role="guide" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">ä¼Šæ­</div>
            <div class="preview-emotion">æ€’ Angry</div>
          </div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å“ˆçš®</div>
            <div class="preview-emotion">æ€’ Angry</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="angry">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">BLUE</div>
            <div class="preview-emotion">æ€’ Angry</div>
          </div>
        </div>

        <!-- å“€ Sad -->
        <div class="preview-slot guide" data-role="guide" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">ä¼Šæ­</div>
            <div class="preview-emotion">å“€ Sad</div>
          </div>
        </div>
        <div class="preview-slot writer" data-role="writer" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å“ˆçš®</div>
            <div class="preview-emotion">å“€ Sad</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="sad">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">BLUE</div>
            <div class="preview-emotion">å“€ Sad</div>
          </div>
        </div>
      </div>
    </div>

    <!-- é¡å¤–åœ–ç‰‡å€ -->
    <div class="progress-section extra-section">
      <div class="progress-header">
        <h2>ğŸ BLUEé¡å¤–åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h2>
        <span class="progress-count" id="extraCount">0 / 7 å¼µ</span>
      </div>

      <div class="drop-zone extra-drop" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleExtraDrop(event)">
        <div class="upload-icon" style="font-size:32px;">ğŸ“</div>
        <div class="upload-desc">æ‹–æ”¾é¡å¤–åœ–ç‰‡æˆ– <strong>é»æ“Šé¸æ“‡</strong></div>
        <input type="file" accept="image/png" multiple onchange="handleExtraFiles(this.files)">
      </div>

      <div class="preview-grid extra-grid">
        <div class="preview-slot player" data-role="player" data-emotion="trophy">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">æ‹¿çç›ƒ</div>
            <div class="preview-emotion">å‡ç´š/æˆå°±</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="mascot">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">æ‹¿ç¶ è‰²å¨ƒå¨ƒ</div>
            <div class="preview-emotion">ç‰¹æ®Šçå‹µ</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="cry">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¤§å“­</div>
            <div class="preview-emotion">ä»»å‹™å¤±æ•—</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="confused">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å›°æƒ‘</div>
            <div class="preview-emotion">éœ€è¦å¹«åŠ©</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-1">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 1</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-2">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 2</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-3">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 3</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-4">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 4</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-5">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 5</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
        <div class="preview-slot player" data-role="player" data-emotion="writing-6">
          <div class="preview-empty">+</div>
          <div class="preview-info">
            <div class="preview-role">å¯«ç­†è¨˜ 6</div>
            <div class="preview-emotion">è¼¸å…¥ä¸­</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å‚™è¨»æ¬„ -->
    <div class="notes-section">
      <h2>ğŸ“ å‚™è¨»çµ¦é–‹ç™¼è€…</h2>
      <textarea id="userNotes" placeholder="èªªæ˜æ¯å¼µåœ–çš„å…§å®¹ã€ç”¨é€”ã€æˆ–ä»»ä½•æƒ³æ³•...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- å¯«ç­†è¨˜1: ä½é ­å°ˆå¿ƒå¯«&#10;- å¯«ç­†è¨˜2: æŠ¬é ­æ€è€ƒ&#10;- å¤§å“­: çœ¼æ·šå™´å‡ºä¾†é‚£ç¨®"></textarea>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="actions">
      <button class="btn btn-secondary" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨</button>
      <button class="btn btn-primary" id="downloadBtn" onclick="downloadAll()" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        ä¸‹è¼‰ ZIPï¼ˆæ­£ç¢ºæª”åï¼‰
      </button>
    </div>

    <footer>
      <p>Â© 2026 Kaoru Tsai. All Rights Reserved. | Contact: <a href="mailto:hello@helloruru.com">hello@helloruru.com</a></p>
      <p style="margin-top: 8px;">
        <a href="../../docs/character-design.md" target="_blank">æŸ¥çœ‹å®Œæ•´è§’è‰²è¨­è¨ˆéœ€æ±‚æ–‡ä»¶</a>
      </p>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const uploadedFiles = new Map();
    const roles = ['guide', 'writer', 'player'];
    const emotions = ['joy', 'happy', 'angry', 'sad'];
    const extraEmotions = ['trophy', 'mascot', 'cry', 'confused', 'writing-1', 'writing-2', 'writing-3', 'writing-4', 'writing-5', 'writing-6'];

    // å¾æª”åçŒœè§’è‰²
    function guessRole(filename) {
      const lower = filename.toLowerCase();
      if (lower.includes('guide') || lower.includes('å°c') || lower.includes('c-') || lower.includes('navigator')) return 'guide';
      if (lower.includes('writer') || lower.includes('å“ˆçš®') || lower.includes('h-') || lower.includes('bard')) return 'writer';
      if (lower.includes('player') || lower.includes('blue') || lower.includes('l-') || lower.includes('lulu')) return 'player';
      return null;
    }

    // å¾æª”åçŒœè¡¨æƒ…
    function guessEmotion(filename) {
      const lower = filename.toLowerCase();
      if (lower.includes('joy') || lower.includes('æ¨‚') || lower.includes('smile') || lower.includes('normal')) return 'joy';
      if (lower.includes('happy') || lower.includes('å–œ') || lower.includes('cheer') || lower.includes('yay')) return 'happy';
      if (lower.includes('angry') || lower.includes('æ€’') || lower.includes('mad') || lower.includes('warn')) return 'angry';
      if (lower.includes('sad') || lower.includes('å“€') || lower.includes('cry') || lower.includes('worry')) return 'sad';
      return null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    }

    function handleFiles(files) {
      const pngFiles = Array.from(files).filter(f => f.type === 'image/png');

      if (pngFiles.length === 0) {
        alert('è«‹ä¸Šå‚³ PNG æ ¼å¼çš„åœ–ç‰‡');
        return;
      }

      // å–å¾—æ‰€æœ‰ç©ºä½
      const emptySlots = [];
      for (const emotion of emotions) {
        for (const role of roles) {
          const key = `${role}-${emotion}.png`;
          if (!uploadedFiles.has(key)) {
            emptySlots.push({ role, emotion, key });
          }
        }
      }

      pngFiles.forEach((file, index) => {
        const role = guessRole(file.name);
        const emotion = guessEmotion(file.name);

        let targetKey = null;

        // å¦‚æœéƒ½çŒœåˆ°äº†ï¼Œç›´æ¥ç”¨
        if (role && emotion) {
          targetKey = `${role}-${emotion}.png`;
        }
        // åªçŒœåˆ°è§’è‰²ï¼Œæ‰¾è©²è§’è‰²çš„ç©ºä½
        else if (role) {
          const slot = emptySlots.find(s => s.role === role);
          if (slot) targetKey = slot.key;
        }
        // åªçŒœåˆ°è¡¨æƒ…ï¼Œæ‰¾è©²è¡¨æƒ…çš„ç©ºä½
        else if (emotion) {
          const slot = emptySlots.find(s => s.emotion === emotion);
          if (slot) targetKey = slot.key;
        }
        // éƒ½çŒœä¸åˆ°ï¼Œç”¨ä¸‹ä¸€å€‹ç©ºä½
        else {
          if (emptySlots.length > 0) {
            targetKey = emptySlots[0].key;
          }
        }

        if (targetKey && !uploadedFiles.has(targetKey)) {
          uploadedFiles.set(targetKey, file);

          // å¾ç©ºä½ç§»é™¤
          const idx = emptySlots.findIndex(s => s.key === targetKey);
          if (idx > -1) emptySlots.splice(idx, 1);

          // æ›´æ–° UI
          const [r, e] = targetKey.replace('.png', '').split('-');
          updateSlot(r, e, file);
        }
      });

      updateProgress();
    }

    function updateSlot(role, emotion, file) {
      const slot = document.querySelector(`.preview-slot[data-role="${role}"][data-emotion="${emotion}"]`);
      if (!slot) return;

      slot.classList.add('filled');

      // æ¸…é™¤èˆŠå…§å®¹
      const oldImg = slot.querySelector('.preview-img');
      const oldEmpty = slot.querySelector('.preview-empty');
      if (oldImg) oldImg.remove();
      if (oldEmpty) oldEmpty.remove();

      // æ–°å¢é è¦½
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.className = 'preview-img';
        img.src = e.target.result;
        slot.insertBefore(img, slot.firstChild);
      };
      reader.readAsDataURL(file);

      // æ–°å¢åˆªé™¤æŒ‰éˆ•
      let removeBtn = slot.querySelector('.preview-remove');
      if (!removeBtn) {
        removeBtn = document.createElement('button');
        removeBtn.className = 'preview-remove';
        removeBtn.textContent = 'Ã—';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          removeFile(role, emotion);
        };
        slot.appendChild(removeBtn);
      }

      // é¡¯ç¤ºåŸå§‹æª”å
      let fnEl = slot.querySelector('.preview-filename');
      if (!fnEl) {
        fnEl = document.createElement('div');
        fnEl.className = 'preview-filename';
        slot.querySelector('.preview-info').appendChild(fnEl);
      }
      fnEl.textContent = `â† ${file.name}`;
    }

    function removeFile(role, emotion) {
      const key = `${role}-${emotion}.png`;
      uploadedFiles.delete(key);

      const slot = document.querySelector(`.preview-slot[data-role="${role}"][data-emotion="${emotion}"]`);
      slot.classList.remove('filled');

      const img = slot.querySelector('.preview-img');
      if (img) img.remove();

      const removeBtn = slot.querySelector('.preview-remove');
      if (removeBtn) removeBtn.remove();

      const fnEl = slot.querySelector('.preview-filename');
      if (fnEl) fnEl.remove();

      // é‡æ–°åŠ å…¥ç©ºç™½
      const empty = document.createElement('div');
      empty.className = 'preview-empty';
      empty.textContent = '+';
      slot.insertBefore(empty, slot.firstChild);

      updateProgress();
    }

    // é¡å¤–åœ–ç‰‡è™•ç†
    function handleExtraDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      handleExtraFiles(e.dataTransfer.files);
    }

    function handleExtraFiles(files) {
      const pngFiles = Array.from(files).filter(f => f.type === 'image/png');
      if (pngFiles.length === 0) return;

      // æ‰¾ç©ºä½
      const emptySlots = extraEmotions.filter(em => !uploadedFiles.has(`player-${em}.png`));

      pngFiles.forEach((file, index) => {
        // å˜—è©¦å¾æª”åçŒœ
        let emotion = guessExtraEmotion(file.name);
        let targetKey = emotion ? `player-${emotion}.png` : null;

        // å¦‚æœçŒœä¸åˆ°æˆ–å·²æ»¿ï¼Œç”¨ä¸‹ä¸€å€‹ç©ºä½
        if (!targetKey || uploadedFiles.has(targetKey)) {
          if (emptySlots.length > index) {
            targetKey = `player-${emptySlots[index]}.png`;
          } else {
            return;
          }
        }

        if (targetKey && !uploadedFiles.has(targetKey)) {
          uploadedFiles.set(targetKey, file);
          const em = targetKey.replace('player-', '').replace('.png', '');
          updateSlot('player', em, file);

          const idx = emptySlots.indexOf(em);
          if (idx > -1) emptySlots.splice(idx, 1);
        }
      });

      updateProgress();
    }

    function guessExtraEmotion(filename) {
      const lower = filename.toLowerCase();
      if (lower.includes('trophy') || lower.includes('çç›ƒ') || lower.includes('çæ¯')) return 'trophy';
      if (lower.includes('mascot') || lower.includes('å¨ƒå¨ƒ') || lower.includes('doll')) return 'mascot';
      if (lower.includes('cry') || lower.includes('å¤§å“­') || lower.includes('å“­')) return 'cry';
      if (lower.includes('confus') || lower.includes('å›°æƒ‘') || lower.includes('å•è™Ÿ')) return 'confused';
      if (lower.includes('writing') || lower.includes('å¯«') || lower.includes('ç­†è¨˜') || lower.includes('note')) {
        // å˜—è©¦æ‰¾æ•¸å­—
        const match = lower.match(/(\d)/);
        if (match) return `writing-${match[1]}`;
        return 'writing-1';
      }
      return null;
    }

    function updateProgress() {
      // åŸºæœ¬ 12 å¼µ
      const baseCount = [...uploadedFiles.keys()].filter(k => {
        const em = k.replace('player-', '').replace('guide-', '').replace('writer-', '').replace('.png', '');
        return emotions.includes(em);
      }).length;

      const basePercent = (baseCount / 12) * 100;
      document.getElementById('progressFill').style.width = basePercent + '%';
      document.getElementById('progressCount').textContent = `${baseCount} / 12 å¼µ`;

      // é¡å¤–åœ–ç‰‡
      const extraCount = [...uploadedFiles.keys()].filter(k => {
        const em = k.replace('player-', '').replace('.png', '');
        return extraEmotions.includes(em);
      }).length;

      const extraEl = document.getElementById('extraCount');
      if (extraEl) {
        const extraSlots = document.querySelectorAll('.extra-grid .preview-slot').length;
        extraEl.textContent = `${extraCount} / ${extraSlots} å¼µ`;
      }

      document.getElementById('downloadBtn').disabled = uploadedFiles.size === 0;
    }

    function clearAll() {
      if (uploadedFiles.size === 0) return;
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨å—ï¼Ÿ')) return;

      uploadedFiles.clear();

      document.querySelectorAll('.preview-slot').forEach(slot => {
        slot.classList.remove('filled');

        const img = slot.querySelector('.preview-img');
        if (img) img.remove();

        const removeBtn = slot.querySelector('.preview-remove');
        if (removeBtn) removeBtn.remove();

        const fnEl = slot.querySelector('.preview-filename');
        if (fnEl) fnEl.remove();

        let empty = slot.querySelector('.preview-empty');
        if (!empty) {
          empty = document.createElement('div');
          empty.className = 'preview-empty';
          empty.textContent = '+';
          slot.insertBefore(empty, slot.firstChild);
        }
      });

      document.querySelector('.upload-zone input').value = '';
      updateProgress();
    }

    async function downloadAll() {
      if (uploadedFiles.size === 0) return;

      const btn = document.getElementById('downloadBtn');
      btn.disabled = true;
      btn.innerHTML = 'â³ æ‰“åŒ…ä¸­...';

      try {
        const zip = new JSZip();

        for (const [filename, file] of uploadedFiles) {
          const buffer = await file.arrayBuffer();
          zip.file(filename, buffer);
        }

        // åŠ å…¥å‚™è¨»
        const notes = document.getElementById('userNotes').value.trim();
        if (notes) {
          zip.file('_å‚™è¨».txt', notes);
        }

        // åŠ å…¥æª”æ¡ˆæ¸…å–®
        const fileList = [...uploadedFiles.keys()].sort().join('\n');
        zip.file('_æª”æ¡ˆæ¸…å–®.txt', `å·²ä¸Šå‚³ ${uploadedFiles.size} å¼µåœ–ç‰‡ï¼š\n\n${fileList}`);

        const blob = await zip.generateAsync({ type: 'blob' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'sge-writer-characters.zip';
        link.click();
        URL.revokeObjectURL(link.href);

        btn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          ä¸‹è¼‰ ZIPï¼ˆæ­£ç¢ºæª”åï¼‰
        `;
        btn.disabled = false;
      } catch (err) {
        alert('æ‰“åŒ…å¤±æ•—ï¼š' + err.message);
        btn.innerHTML = 'ä¸‹è¼‰ ZIP';
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
